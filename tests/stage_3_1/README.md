# 階段3.1：服務間通信驗證與啟動測試

## 📋 測試概述

階段3.1專注於驗證分離式服務架構中三個獨立服務間的通信和啟動能力：

### 🎯 測試目標

1. **驗證模型服務 → 後端服務的數據傳輸通道**
   - VLM觀察間隔控制功能
   - VLM文字傳輸到State Tracker

2. **驗證後端服務 → 前端服務的查詢響應通道**
   - State Tracker + RAG處理結果
   - API端點響應能力

3. **驗證前端服務 → 後端服務的用戶查詢傳輸通道**
   - 用戶查詢傳輸
   - 即時響應機制

4. **測試各服務的獨立啟動**
   - 後端服務獨立啟動
   - 前端服務獨立可用
   - 服務間不需要整合為單一系統

5. **確認端口通信正常**
   - 後端服務端口8000
   - 各API端點可訪問性

6. **驗證基礎數據流**
   - 端到端數據流：VLM文字 → State Tracker → 前端顯示

## 🚀 執行方式

### 方式一：執行完整測試套件（推薦）

```bash
# 進入測試目錄
cd tests/stage_3_1

# 執行完整的階段3.1測試
python run_stage_3_1_tests.py
```

### 方式二：執行主要測試腳本

```bash
# 執行主要的測試腳本（已驗證100%成功率）
python test_proper_sequence.py
```

## 📋 前置條件

### 1. 後端服務準備
確保後端服務可以正常啟動：

```bash
# 進入後端目錄
cd src/backend

# 安裝依賴（如果需要）
pip install -r requirements.txt

# 啟動後端服務
python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

### 2. 前端文件檢查
確保前端文件存在：
- `src/frontend/index.html`
- `src/frontend/query.html`

### 3. Python依賴
測試腳本需要以下依賴：
```bash
pip install aiohttp requests psutil
```

## 📊 測試內容詳解

### 主要測試腳本 (`test_proper_sequence.py`)

| 測試項目 | 描述 | 驗證內容 |
|---------|------|---------|
| 模型服務啟動 | 測試SmolVLM服務啟動 | 端口8080、llama-server啟動、服務響應 |
| 後端服務啟動 | 測試FastAPI後端啟動 | 端口8000、uvicorn啟動、健康檢查 |
| 服務通信測試 | 測試6個關鍵端點 | 健康檢查、狀態端點、VLM通信、State Tracker等 |

### 完整測試套件 (`run_stage_3_1_tests.py`)

| 測試項目 | 描述 | 驗證內容 |
|---------|------|---------|
| 服務啟動測試 | 模型和後端服務啟動 | 獨立啟動、端口配置、服務獨立性 |
| 通信測試 | 10個完整測試項目 | 所有API端點、數據流、性能指標 |
| 綜合報告 | 生成詳細測試報告 | 測試結果、性能分析、下一步建議 |

### 測試腳本特點
- **虛擬環境支援**：自動檢測和啟用`ai_vision_env`
- **重試機制**：服務啟動失敗時自動重試
- **端口清理**：自動清理被占用的端口
- **完整清理**：測試結束後自動清理所有進程

## 📈 測試報告

### 報告文件
測試完成後會生成以下報告文件：

1. **綜合報告**: `stage_3_1_comprehensive_report_YYYYMMDD_HHMMSS.json`
2. **測試記錄**: `STAGE_3_1_TEST_RECORD.md`
3. **完成標記**: `../../docs/development_stages/STAGE_3_1_COMPLETE.md`（測試全部通過時）

### 最新測試結果 (2025-08-09)
- **總測試數**: 10
- **通過測試**: 10
- **失敗測試**: 0
- **成功率**: 100.0%
- **整體狀態**: PASS

### 報告內容
- 測試執行摘要
- 各項測試詳細結果
- 性能指標（響應時間等）
- 發現的問題和建議
- 下一步行動計劃

## ✅ 成功標準

階段3.1被視為成功完成需要滿足：

1. **所有啟動測試通過** (100%)
   - 模型服務可以獨立啟動
   - 後端服務可以獨立啟動
   - 端口配置正確
   - 服務獨立性驗證通過

2. **所有通信測試通過** (100%)
   - 所有API端點正常響應
   - VLM文字處理流程正常
   - 用戶查詢流程正常
   - 端到端數據流正常

3. **性能指標達標**
   - API響應時間 < 5秒
   - 端到端處理時間 < 10秒

## 🔧 故障排除

### 常見問題

1. **後端服務啟動失敗**
   ```bash
   # 檢查端口是否被占用
   lsof -i :8000
   
   # 檢查依賴是否安裝
   pip list | grep fastapi
   ```

2. **API端點無響應**
   ```bash
   # 手動測試端點
   curl http://localhost:8000/health
   curl http://localhost:8000/status
   ```

3. **前端文件缺失**
   ```bash
   # 檢查文件是否存在
   ls -la src/frontend/index.html
   ls -la src/frontend/query.html
   ```

### 調試模式
如需詳細調試信息，可以設置環境變量：

```bash
export PYTHONPATH=$PWD
export LOG_LEVEL=DEBUG
python test_proper_sequence.py
```

## 🎯 下一步

階段3.1完成後，可以進入：
- **階段3.2**: 雙循環跨服務協調與穩定性
- **階段3.3**: 跨服務基礎功能測試

## 📞 支援

如果測試過程中遇到問題，請檢查：
1. 測試報告中的錯誤信息
2. 後端服務日誌
3. 網絡連接狀態
4. Python依賴版本

---

**執行日期**: 2025年8月9日 (最新)  
**測試版本**: Stage 3.1  
**架構**: 分離式服務雙循環記憶系統  
**主要測試腳本**: `test_proper_sequence.py` (100%成功率)  
**完整測試套件**: `run_stage_3_1_tests.py` (100%成功率)  
**測試狀態**: ✅ 已完成並驗證成功