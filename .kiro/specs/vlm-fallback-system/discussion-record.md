# VLM Fallback System - 討論記錄

## 討論概述

**日期**: 2025-01-31
**參與者**: AI Assistant, User
**主題**: VLM Fallback System 功能設計和實現方案
**狀態**: 已完成初步設計和文檔準備

## 討論內容

### 1. 問題背景討論

#### 1.1 用戶提出的問題
**User**: "我想請你幫我看一下我的程式碼。我現在有個想法，我們可不可以當信心值過低，或是使用者詢問的問題，可能與流程不相關，這時我們改使用vlm回覆。直接將vlm提示詞改成使用成的問題，並將問題回覆。當回覆後再把提示詞改成原先狀態，繼續追蹤當下狀況。"

#### 1.2 問題分析
**Assistant**: 分析了現有系統的問題：
- 當置信度 < 0.40 時，系統返回 "No active state"
- 用戶查詢與任務流程無關時，無法提供有用回應
- 系統缺乏靈活性，只能處理預定義的查詢類型

#### 1.3 解決方案提出
**Assistant**: 提出了 VLM Fallback System 的概念：
- **智能回退機制**：自動判斷是否需要 VLM 直接回答
- **動態提示詞切換**：在狀態追蹤和直接回答間無縫切換
- **狀態保護**：確保原始狀態追蹤不受影響

### 2. 技術可行性分析

#### 2.1 現有架構評估
**Assistant**: 分析了現有系統的技術基礎：
- ✅ VLM 代理端點 (`/v1/chat/completions`)
- ✅ 查詢處理器 (`QueryProcessor`)
- ✅ 狀態追蹤器 (`StateTracker`)
- ✅ 後端 API 框架 (`FastAPI`)
- ✅ 日誌系統 (完整的追蹤機制)

#### 2.2 實現複雜度評估
**Assistant**: 評估了實現複雜度：
- **簡單的部分（80%）**：重用現有組件，添加新邏輯
- **需要考慮的部分（20%）**：提示詞管理、並發處理、性能優化

#### 2.3 風險評估
**Assistant**: 識別了主要風險：
- **低風險**：不破壞現有功能，向後兼容
- **中風險**：提示詞切換、並發處理
- **可控風險**：性能影響、錯誤處理

### 3. 功能設計討論

#### 3.1 觸發條件設計
**User**: 確認了觸發條件：
- 置信度過低（< 0.30）
- 查詢類型為 UNKNOWN
- 無有效狀態數據

#### 3.2 模式切換設計
**Assistant**: 提出了兩種模式：
- **Template Mode**：用於任務相關查詢（現有功能）
- **VLM Direct Mode**：用於一般性問題（新功能）

#### 3.3 提示詞管理設計
**User**: 確認了提示詞切換流程：
1. 保存當前 VLM 提示詞
2. 切換到直接回答提示詞
3. 發送 VLM 請求
4. 恢復原始提示詞

### 4. 實現方案討論

#### 4.1 架構設計
**Assistant**: 提出了核心組件：
- `DecisionEngine`：決策邏輯
- `PromptManager`：提示詞管理
- `VLMClient`：VLM 服務客戶端
- `ErrorHandler`：錯誤處理

#### 4.2 集成策略
**Assistant**: 提出了集成策略：
- 修改 `QueryProcessor` 添加回退邏輯
- 修改 `StateTracker` 支持新功能
- 更新後端 API 支持圖片數據
- 更新前端支持新的響應格式

#### 4.3 測試策略
**Assistant**: 提出了測試計劃：
- 單元測試：各組件獨立測試
- 集成測試：端到端流程測試
- 性能測試：響應時間和並發測試

### 5. 用戶體驗討論

#### 5.1 響應質量
**User**: 關注回答質量：
- 相關性：回答與用戶問題高度相關
- 準確性：提供準確、可靠的信息
- 完整性：回答完整，不遺漏重要信息

#### 5.2 交互體驗
**Assistant**: 強調無縫體驗：
- 無縫切換：用戶感知不到模式切換
- 一致性：回答風格保持一致
- 即時性：快速響應用戶查詢

#### 5.3 透明度
**User**: 要求透明度：
- 模式標識：在回應中標識回答模式
- 狀態指示：顯示系統當前狀態
- 錯誤提示：友好的錯誤信息

### 6. 實現計劃討論

#### 6.1 階段劃分
**Assistant**: 提出了三階段實現計劃：
- **階段 1**：核心功能實現（Week 1）
- **階段 2**：API 和前端集成（Week 2）
- **階段 3**：測試和優化（Week 3）

#### 6.2 優先級排序
**User**: 確認了優先級：
- **高優先級**：核心功能、基本集成
- **中優先級**：性能優化、錯誤處理
- **低優先級**：高級功能、監控

#### 6.3 風險緩解
**Assistant**: 提出了風險緩解措施：
- 完整的錯誤恢復機制
- 多層回退機制
- 緩存和性能優化

### 7. 文檔組織討論

#### 7.1 文檔結構
**User**: 要求創建完整的文檔結構：
- `README.md`：總覽文檔
- `requirements.md`：功能需求規格
- `design.md`：系統設計文檔
- `tasks.md`：開發任務清單
- `discussion-record.md`：討論記錄

#### 7.2 文檔分類
**Assistant**: 建議按功能分類：
- 在 `.kiro/specs/` 下創建 `vlm-fallback-system/` 目錄
- 與現有的 `memory-system/` 和 `logging-system/` 並列
- 保持文檔結構的一致性

## 決策記錄

### 已決策事項

#### 1. 功能範圍
- ✅ 實現 VLM Fallback System
- ✅ 支持動態提示詞切換
- ✅ 保持向後兼容性
- ✅ 完整的錯誤處理

#### 2. 技術方案
- ✅ 基於現有架構擴展
- ✅ 模組化設計
- ✅ 配置化管理
- ✅ 完整的測試覆蓋

#### 3. 實現計劃
- ✅ 三階段實現
- ✅ 2-3 週時間線
- ✅ 風險緩解措施
- ✅ 完整的文檔

### 待決策事項

#### 1. 具體實現細節
- [ ] 提示詞模板的具體內容
- [ ] 決策算法的權重設置
- [ ] 緩存策略的具體實現
- [ ] 監控指標的定義

#### 2. 配置參數
- [ ] 置信度閾值的具體數值
- [ ] 超時時間的設置
- [ ] 重試次數的配置
- [ ] 日誌級別的設置

#### 3. 用戶界面
- [ ] 模式切換指示器的設計
- [ ] 錯誤信息的顯示方式
- [ ] 響應格式的具體定義

## 後續行動

### 短期行動（本週）
1. ✅ 完成文檔創建和組織
2. [ ] 開始核心功能實現
3. [ ] 創建基礎架構

### 中期行動（下週）
1. [ ] 完成核心功能實現
2. [ ] 開始 API 集成
3. [ ] 開始前端集成

### 長期行動（第三週）
1. [ ] 完成測試和優化
2. [ ] 完成文檔和部署
3. [ ] 用戶驗收測試

## 總結

本次討論成功確定了 VLM Fallback System 的整體設計和實現方案。該系統將顯著提升用戶體驗，讓系統從「任務追蹤工具」變成「智能助手」。實現方案技術可行，風險可控，預計 2-3 週內可以完成開發和部署。

**下一步**：開始第一階段的核心功能實現。 