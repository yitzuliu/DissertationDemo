# AI Manual Assistant Logging System Design Specification

## Overview
This document defines the unified logging and data tracking standards for the AI Manual Assistant system. Ensures all critical system, visual, and user interactions are recorded in a structured, consistent, and traceable manner. This design supports debugging, monitoring, analysis, and future development.

---

## 1. Log Categories and Files

- **System Technical Logs**: `src/app_logging/logs/system_YYYYMMDD.log`
- **Visual Observation Logs**: `src/app_logging/logs/visual_YYYYMMDD.log`
- **User Query Logs**: `src/app_logging/logs/user_YYYYMMDD.log`
- **Unified Flow Tracking Logs**: `src/app_logging/logs/flow_tracking_YYYYMMDD.log`

Each log file rotates daily, using consistent timestamp format.

---

## 2. Event-Driven Unique IDs and Traceability

- **observation_id**: Unique identifier for each VLM (visual) observation event (generated by backend for each image capture/analysis cycle).
- **state_update_id**: Unique identifier for each state update event (generated by state_tracker when state changes).
- **query_id**: Unique identifier for each user query event (generated by backend or state_tracker for each user query).
- **request_id**: Unique identifier for each API request (generated by backend for each HTTP/API call).
- **flow_id**: Used to group related events (e.g., user query and based observation).

**Traceability Principles:**
- Each event log contains its own unique ID.
- Logs reference related IDs (e.g., user query log contains the observation_id it's based on).
- This enables complete traceability for asynchronous, event-driven flows.

---

## 3. Log Types, Fields, and Example Formats

### 3.1 System Technical Logs
**Purpose:** Record all system-level events, resource usage, endpoint interactions, and connection status.  
**Responsible Module:** backend (main.py), infrastructure/ops scripts

**Key Events:**
- System startup/shutdown
- Configuration loading
- Memory/CPU usage
- Endpoint/API calls
- Connection status (frontend, model server, database)
- Error handling and recovery

**Example:**
```
2025-07-30 09:00:00,000 [SYSTEM_START] system_id=sys_001, host=localhost, port=8000, model=smolvlm
2025-07-30 09:00:00,010 [MEMORY] system_id=sys_001, startup_memory=22.1MB
2025-07-30 09:01:12,345 [ENDPOINT] request_id=req_1753873272345, method=POST, path=/v1/chat/completions, status=200, duration=2.31s
2025-07-30 09:30:00,000 [SYSTEM_SHUTDOWN] system_id=sys_001, final_memory=22.5MB, uptime=30min
```

---

### 3.2 Visual Observation Logs
**Purpose:** Track all visual data flows, including image capture, prompt usage, backend transfer, RAG matching, and state tracking.  
**Responsible Module:** frontend (image capture, prompts), backend (main.py, image processing), rag, state_tracker

**Key Events:**
- Image capture (timestamp, device, resolution, quality, format, size)
- Visual prompts used (content, length, type)
- Data sent to backend (question, image metadata, token count)
- Backend reception (complete message structure)
- RAG matching process (VLM observation, candidate steps, similarity scores)
- RAG matching result (selected step, title, similarity)
- State tracker decisions (confidence, action, updated state)
- All events should include observation_id and request_id for traceability

**Example:**
```
2025-07-30 09:01:10,000 [EYES_CAPTURE] observation_id=obs_123, request_id=req_1753873272345, device=MacBook FaceTime HD, resolution=1920x1080, quality=0.9, format=JPEG, size=1.2MB
2025-07-30 09:01:10,001 [EYES_PROMPT] observation_id=obs_123, prompt="Describe the steps for making coffee...", length=48 chars
2025-07-30 09:01:10,002 [EYES_TRANSFER] observation_id=obs_123, sent_to_backend={question: "How to make coffee?", image: [base64], tokens: 100}
2025-07-30 09:01:10,200 [RAG_MATCHING] observation_id=obs_123, vlm_observation="There are coffee filters and drip coffee maker on the table.", candidate_steps=[step1, step2, step3, step4], similarities=[0.82, 0.65, 0.12, 0.05]
2025-07-30 09:01:10,230 [RAG_RESULT] observation_id=obs_123, selected=step2, title="Rinse the filter paper", similarity=0.82
2025-07-30 09:01:10,240 [STATE_TRACKER] observation_id=obs_123, state_update_id=state_456, confidence=0.82, action=UPDATE, state={task:brewing_coffee, step:2}
```

---

### 3.3 User Query Logs
**Purpose:** Record all user queries, classification, processing, and responses for traceability and analysis.  
**Responsible Module:** frontend (user input), backend (main.py), state_tracker

**Key Events:**
- Receive user query (query_id, request_id, content, language)
- Query classification (type, confidence)
- Query processing (current state, step, task)
- Query response (content, processing time)
- All events should include query_id, request_id, and observation_id used for response

**Example:**
```
2025-07-30 09:01:15,000 [USER_QUERY] query_id=query_789, request_id=req_1753873275000, question="What tools do I need?", language=en, used_observation_id=obs_123
2025-07-30 09:01:15,001 [QUERY_CLASSIFY] query_id=query_789, type=required_tools, confidence=0.95
2025-07-30 09:01:15,002 [QUERY_PROCESS] query_id=query_789, state={task:brewing_coffee, step:2}
2025-07-30 09:01:15,003 [QUERY_RESPONSE] query_id=query_789, response="You need: filter paper, drip coffee maker, hot water, cup.", duration=1.2ms
```

---

### 3.4 Unified Flow Tracking Logs
**Purpose:** Provide end-to-end traceability for each user/system flow by linking all related events through unique flow_id.  
**Responsible Module:** backend (main.py), orchestrator, ops/monitoring

**Key Events:**
- Flow start (flow_id, type, start time)
- Each major step (step name, timestamp, related IDs)
- Flow end (status, total duration, result)

**Example:**
```
2025-07-30 09:01:10,000 [FLOW_START] flow_id=flow_1753873272345, type=EYES_OBSERVATION, started
2025-07-30 09:01:10,250 [FLOW_STEP] flow_id=flow_1753873272345, step=image_capture, observation_id=obs_123
2025-07-30 09:01:10,300 [FLOW_STEP] flow_id=flow_1753873272345, step=backend_transfer, request_id=req_1753873272345
2025-07-30 09:01:10,400 [FLOW_STEP] flow_id=flow_1753873272345, step=rag_matching, observation_id=obs_123
2025-07-30 09:01:10,500 [FLOW_STEP] flow_id=flow_1753873272345, step=state_update, state_update_id=state_456
2025-07-30 09:01:15,003 [FLOW_STEP] flow_id=flow_1753873272345, step=user_query, query_id=query_789
2025-07-30 09:01:15,004 [FLOW_END] flow_id=flow_1753873272345, status=SUCCESS, total_duration=5.0s
```

---

## 4. Log Management, Rotation, and Storage

- **Directory Structure:**
  - `src/app_logging/logs/system_YYYYMMDD.log`      # System logs
  - `src/app_logging/logs/visual_YYYYMMDD.log`      # Visual logs
  - `src/app_logging/logs/user_YYYYMMDD.log`        # User logs
  - `src/app_logging/logs/flow_tracking_YYYYMMDD.log` # Flow logs
  - `src/app_logging/logs/archive/`                 # Monthly archived logs
- **Rotation:**
  - Daily log rotation
  - Compress logs after 7 days
  - Retain for 30 days, then archive monthly
- **Performance/Storage:**
  - Estimate: System (10-20MB/day), Visual (50-100MB/day), User (5-10MB/day)
  - Total: Typical 65-130MB/day

---

## 5. Query and Analysis

- **Timestamp-based Correlation:**
  - Use timestamps and unique IDs to correlate user queries with recent observations/state updates.
- **Example Analysis Commands:**
```bash
# Find user queries at specific time
grep "09:01:15" src/app_logging/logs/user_20250730.log
# Find recent state updates before that time
grep -B5 -A5 "09:01:10" src/app_logging/logs/visual_20250730.log
```
- **Error/Performance Diagnostics:**
```bash
# Check failed VLM processing
grep "action=FAIL" src/app_logging/logs/visual_20250730.log
# Check failed user query classification
grep "confidence<0.5" src/app_logging/logs/user_20250730.log
# Check system memory usage
grep "MEMORY" src/app_logging/logs/system_20250730.log
```

---

## 6. Implementation Phases and Module Responsibilities

### Phase 1: Core LogManager and System Logs (Week 1)
- Implement LogManager class (`src/app_logging/log_manager.py`)
- System startup/shutdown, endpoint, and error logs
- Daily rotation and archiving

### Phase 2: Visual Flow Logs (Week 2)
- Frontend: Image capture, prompt, and transfer logs
- Backend: Image reception, VLM processing, RAG matching logs
- State tracker: State update logs

### Phase 3: User Query Logs (Week 3)
- Frontend: User input logs
- Backend: Query reception, classification, response logs
- State tracker: Query processing logs

### Phase 4: Unified Flow Tracking and Analysis Tools (Week 4)
- Implement flow_id correlation across all logs (`src/app_logging/flow_tracker.py`)
- Develop log analysis scripts and dashboards
- Integrate with monitoring/alerting systems

---

## 7. Log Event to Module Responsibility Mapping

| Log Event Type         | Example Log Tag      | Responsible Module         |
|-----------------------|---------------------|------------------------------|
| System Startup        | SYSTEM_START        | backend (main.py), ops       |
| Memory Usage          | MEMORY              | backend, ops                 |
| Endpoint Call         | ENDPOINT            | backend (main.py)            |
| Image Capture         | EYES_CAPTURE        | frontend                     |
| Visual Prompt         | EYES_PROMPT         | frontend                     |
| Backend Transfer      | EYES_TRANSFER       | frontend, backend            |
| VLM Processing        | RAG_MATCHING        | backend, rag                 |
| RAG Match Result      | RAG_RESULT          | rag                          |
| State Update          | STATE_TRACKER       | state_tracker                |
| User Query            | USER_QUERY          | frontend, backend            |
| Query Classification  | QUERY_CLASSIFY      | backend, state_tracker       |
| Query Processing      | QUERY_PROCESS       | state_tracker                |
| Query Response        | QUERY_RESPONSE      | backend, state_tracker       |
| Flow Start/Step/End   | FLOW_START/STEP/END | backend, orchestrator, ops   |

---

## 8. Logging Best Practices

- Always include unique IDs (observation_id, query_id, request_id, state_update_id, flow_id) for traceability.
- Use consistent timestamp format: `YYYY-MM-DD HH:MM:SS,mmm`
- Log all critical data fields (content, type, confidence, status, etc.)
- Separate logs by category for easy analysis and monitoring.
- Avoid logging sensitive data (e.g., raw image base64) unless needed for debugging.
- Rotate logs daily and archive as needed.
- Log structure and field names should be consistent across all modules.
- Loggers should be initialized per module with appropriate file handlers.
- Future extensions (e.g., metrics, alerts) should follow the same structure.

---

## 9. Change History
- 2025-07-30: Drafted initial unified version for engineering and operations.
- 2025-07-31: Updated file paths from `src/logging/` to `src/app_logging/` to match actual implementation.
- 2025-07-31: Updated log file paths to reflect actual directory structure.
- 2025-07-31: Updated analysis commands with correct file paths.