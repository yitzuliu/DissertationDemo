<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實際整合測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .log-output { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            margin: 10px 0; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <h1>前端日誌記錄實際整合測試</h1>
    
    <div id="testResults"></div>
    <div id="logOutput" class="log-output"></div>
    
    <script>
        // 從主文件中提取的日誌記錄器代碼
        class FrontendVisualLogger {
            constructor() {
                this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.logToConsole = true;
                this.logToServer = false;
                this.observationId = null;
            }
            
            generateObservationId() {
                const timestamp = Date.now();
                this.observationId = `obs_${timestamp}_${Math.random().toString(36).substr(2, 8)}`;
                return this.observationId;
            }
            
            log(eventType, data) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId,
                    eventType: eventType,
                    data: data
                };
                
                if (this.logToConsole) {
                    console.log(`[FrontendVisualLog] ${eventType}:`, data);
                }
                
                // 顯示在頁面上
                this.displayLog(eventType, logEntry);
            }
            
            displayLog(eventType, logEntry) {
                const logOutput = document.getElementById('logOutput');
                const logDiv = document.createElement('div');
                const timeStr = new Date(logEntry.timestamp).toLocaleTimeString();
                logDiv.innerHTML = `<strong>[${timeStr}] ${eventType}:</strong> ${JSON.stringify(logEntry.data, null, 2)}`;
                logOutput.appendChild(logDiv);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            
            logEyesCapture(observationId, requestId, deviceInfo, imageData) {
                this.log('EYES_CAPTURE', {
                    observation_id: observationId,
                    request_id: requestId,
                    device: deviceInfo.device,
                    resolution: imageData.resolution,
                    quality: imageData.quality,
                    format: imageData.format,
                    size: imageData.size,
                    timestamp: Date.now()
                });
            }
            
            logEyesPrompt(observationId, prompt) {
                this.log('EYES_PROMPT', {
                    observation_id: observationId,
                    prompt: prompt,
                    length: prompt.length,
                    timestamp: Date.now()
                });
            }
            
            logEyesTransfer(observationId, transferData) {
                this.log('EYES_TRANSFER', {
                    observation_id: observationId,
                    sent_to_backend: transferData,
                    timestamp: Date.now()
                });
            }
            
            logUserAction(action, details) {
                this.log('USER_ACTION', {
                    action: action,
                    details: details,
                    timestamp: Date.now()
                });
            }
            
            logError(error, context) {
                this.log('FRONTEND_ERROR', {
                    error: error.toString(),
                    context: context,
                    stack: error.stack,
                    timestamp: Date.now()
                });
            }
        }
        
        // 測試函數
        function runIntegrationTests() {
            const results = [];
            const logger = new FrontendVisualLogger();
            
            // 測試 1: 基本日誌記錄器功能
            try {
                logger.log('TEST', { message: 'test' });
                results.push({ name: '基本日誌記錄', status: 'pass', message: '日誌記錄器正常工作' });
            } catch (error) {
                results.push({ name: '基本日誌記錄', status: 'fail', message: error.message });
            }
            
            // 測試 2: 觀察ID生成
            try {
                const obsId1 = logger.generateObservationId();
                const obsId2 = logger.generateObservationId();
                if (obsId1 !== obsId2 && obsId1.startsWith('obs_')) {
                    results.push({ name: '觀察ID生成', status: 'pass', message: '觀察ID生成正常' });
                } else {
                    results.push({ name: '觀察ID生成', status: 'fail', message: '觀察ID生成異常' });
                }
            } catch (error) {
                results.push({ name: '觀察ID生成', status: 'fail', message: error.message });
            }
            
            // 測試 3: EYES_CAPTURE 日誌
            try {
                const obsId = logger.generateObservationId();
                logger.logEyesCapture(obsId, 'req_123', { device: 'Test Camera' }, {
                    resolution: '1024x768',
                    quality: 0.9,
                    format: 'jpeg',
                    size: '150KB'
                });
                results.push({ name: 'EYES_CAPTURE 日誌', status: 'pass', message: '圖像捕獲日誌正常' });
            } catch (error) {
                results.push({ name: 'EYES_CAPTURE 日誌', status: 'fail', message: error.message });
            }
            
            // 測試 4: EYES_PROMPT 日誌
            try {
                const obsId = logger.observationId;
                logger.logEyesPrompt(obsId, 'What do you see?');
                results.push({ name: 'EYES_PROMPT 日誌', status: 'pass', message: '視覺提示詞日誌正常' });
            } catch (error) {
                results.push({ name: 'EYES_PROMPT 日誌', status: 'fail', message: error.message });
            }
            
            // 測試 5: EYES_TRANSFER 日誌
            try {
                const obsId = logger.observationId;
                logger.logEyesTransfer(obsId, { instruction: 'test', max_tokens: 100 });
                results.push({ name: 'EYES_TRANSFER 日誌', status: 'pass', message: '後端傳輸日誌正常' });
            } catch (error) {
                results.push({ name: 'EYES_TRANSFER 日誌', status: 'fail', message: error.message });
            }
            
            // 測試 6: USER_ACTION 日誌
            try {
                logger.logUserAction('start_processing', { instruction: 'test' });
                results.push({ name: 'USER_ACTION 日誌', status: 'pass', message: '用戶操作日誌正常' });
            } catch (error) {
                results.push({ name: 'USER_ACTION 日誌', status: 'fail', message: error.message });
            }
            
            // 測試 7: ERROR 日誌
            try {
                logger.logError(new Error('Test error'), 'test_context');
                results.push({ name: 'ERROR 日誌', status: 'pass', message: '錯誤日誌正常' });
            } catch (error) {
                results.push({ name: 'ERROR 日誌', status: 'fail', message: error.message });
            }
            
            // 顯示結果
            displayResults(results);
        }
        
        function displayResults(results) {
            const container = document.getElementById('testResults');
            const passCount = results.filter(r => r.status === 'pass').length;
            const totalCount = results.length;
            
            container.innerHTML = `
                <h2>測試結果: ${passCount}/${totalCount} 通過</h2>
                ${results.map(result => `
                    <div class="test-result ${result.status}">
                        <strong>${result.name}:</strong> ${result.message}
                    </div>
                `).join('')}
            `;
        }
        
        // 頁面載入後執行測試
        window.addEventListener('load', () => {
            runIntegrationTests();
        });
    </script>
</body>
</html>