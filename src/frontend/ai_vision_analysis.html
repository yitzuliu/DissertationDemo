<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Intelligence Hub</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="css/index-complete.css">
</head>

<body>
    <!-- Header with logo and status -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-brain"></i>
            <span>Vision Intelligence Hub</span>
        </div>
        <div class="header-status">
            <div class="status-item">
                <span class="status-dot" id="apiStatusDot"></span>
                <span id="apiStatusText">Checking API status...</span>
            </div>
            <div class="status-item">
                <i class="fas fa-microchip"></i>
                <span id="activeModel">Loading model...</span>
            </div>
            <a href="index.html" class="status-item" style="text-decoration: none; color: inherit;">
                <i class="fas fa-home"></i>
                <span>Unified Interface</span>
            </a>
            <a href="query.html" class="status-item" style="text-decoration: none; color: inherit;">
                <i class="fas fa-search"></i>
                <span>Query Only</span>
            </a>
        </div>
    </header>

    <div class="container">
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="main-content-flex">
                <!-- Video and Controls Card -->
                <div class="card video-controls-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-video"></i>
                            Live Camera Feed & Controls
                        </h2>
                    </div>

                    <!-- Content area with video and controls side by side -->
                    <div class="video-controls-layout">
                        <!-- Video container -->
                        <div class="video-section">
                            <div class="video-container">
                                <video id="videoFeed" class="video-preview" autoplay playsinline></video>
                                <canvas id="canvas" style="display:none;"></canvas>
                            </div>
                            <div class="thumbnail-container">
                                <img id="imagePreview" class="image-preview" style="display:none;" />
                                <span class="capture-label">Click Start to begin</span>
                            </div>
                        </div>

                        <!-- Controls container -->
                        <div class="controls-section">
                            <div class="form-group">
                                <label for="instructionText">Ask about the image:</label>
                                <textarea id="instructionText" rows="2"
                                    placeholder="Enter question about the image..."></textarea>
                            </div>

                            <div class="settings-label">
                                <strong>Processing Settings:</strong>
                            </div>

                            <div class="parameter-grid mobile-single-column">
                                <div class="form-group">
                                    <label for="cameraSelect">Select Camera</label>
                                    <select id="cameraSelect"></select>
                                </div>
                                <div>
                                    <label for="intervalSelect">Capture Rate</label>
                                    <select id="intervalSelect">
                                        <option value="2000">2s</option>
                                        <option value="3000">3s</option>
                                        <option value="5000">5s</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="qualitySelect">Image Quality</label>
                                    <select id="qualitySelect">
                                        <option value="0.7">Fast</option>
                                        <option value="0.8">Medium</option>
                                        <option value="0.9" selected>High</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tokensSelect">Max Tokens</label>
                                    <select id="tokensSelect">
                                        <option value="100" selected>100</option>
                                        <option value="200">200</option>
                                        <option value="300">300</option>
                                    </select>
                                </div>
                                <div>
                                    <button id="startButton" class="btn btn-primary">
                                        <i class="fas fa-play"></i>
                                        <span>Start</span>
                                    </button>
                                </div>
                            </div>

                            <div id="modelHelp" class="help-msg" style="display:none;"></div>
                            <div id="errorMsg" class="error-msg" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Response Card -->
                <div class="card response-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-comment-dots"></i>
                            Model Response
                        </h2>
                    </div>
                    <textarea id="responseText" class="response-textarea" readonly
                        placeholder="AI responses will appear here..."></textarea>
                </div>
            </div>
        </div>

        <!-- Sidebar with info cards -->
        <div class="sidebar">
            <!-- System Status Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-server"></i>
                        System Status
                    </h2>
                </div>
                <div class="system-status" id="systemStatus">Backend not connected. Camera works independently.</div>
            </div>

            <!-- Info accordion panel -->
            <div class="card info-tabs-card">
                <!-- Tabs for model info and tips -->
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active-tab" data-target="model-panel">
                            <i class="fas fa-info-circle"></i>
                            Info
                        </button>
                        <button class="tab-btn" data-target="tips-panel">
                            <i class="fas fa-lightbulb"></i>
                            Tips
                        </button>
                    </div>

                    <!-- Content panels -->
                    <div class="tab-content">
                        <!-- Model info content -->
                        <div id="model-panel" class="tab-panel active">
                            <div id="modelDesc">
                                <div class="model-info">
                                    <h4>Vision Intelligence Hub</h4>
                                    <p>This application provides real-time vision analysis using AI models. Connect to
                                        the backend server for full functionality, or use camera features independently.
                                    </p>
                                    <div class="feature-list">
                                        <div class="feature-item">
                                            <i class="fas fa-camera"></i>
                                            <span>Live camera feed</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-brain"></i>
                                            <span>AI vision analysis</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-mobile-alt"></i>
                                            <span>Multi-device support</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tips content -->
                        <div id="tips-panel" class="tab-panel">
                            <ul class="advice-list">
                                <li>Ensure camera permissions are enabled for your browser.</li>
                                <li>Check instruction format if errors occur with AI processing.</li>
                                <li>Adjust capture rate based on your connection speed.</li>
                                <li>Higher image quality provides better AI analysis results.</li>
                                <li>Use descriptive questions for better AI responses.</li>
                                <li>Test different cameras if multiple devices are connected.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules - Fix the import structure -->
    <script type="module">
        // Frontend Visual Logging System
        class FrontendVisualLogger {
            constructor() {
                this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.logToConsole = true;
                this.logToServer = false; // 可以後續啟用發送到後端
                this.observationId = null;
            }

            generateObservationId() {
                const timestamp = Date.now();
                this.observationId = `obs_${timestamp}_${Math.random().toString(36).substr(2, 8)}`;
                return this.observationId;
            }

            log(eventType, data) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId,
                    eventType: eventType,
                    data: data
                };

                if (this.logToConsole) {
                    console.log(`[FrontendVisualLog] ${eventType}:`, data);
                }

                // 未來可以發送到後端
                // if (this.logToServer) {
                //     this.sendToServer(logEntry);
                // }
            }

            logEyesCapture(observationId, requestId, deviceInfo, imageData) {
                this.log('EYES_CAPTURE', {
                    observation_id: observationId,
                    request_id: requestId,
                    device: deviceInfo.device,
                    resolution: imageData.resolution,
                    quality: imageData.quality,
                    format: imageData.format,
                    size: imageData.size,
                    timestamp: Date.now()
                });
            }

            logEyesPrompt(observationId, prompt) {
                this.log('EYES_PROMPT', {
                    observation_id: observationId,
                    prompt: prompt,
                    length: prompt.length,
                    timestamp: Date.now()
                });
            }

            logEyesTransfer(observationId, transferData) {
                this.log('EYES_TRANSFER', {
                    observation_id: observationId,
                    sent_to_backend: transferData,
                    timestamp: Date.now()
                });
            }

            logPageLoad() {
                this.log('PAGE_LOAD', {
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    timestamp: Date.now()
                });
            }

            logUserAction(action, details) {
                this.log('USER_ACTION', {
                    action: action,
                    details: details,
                    timestamp: Date.now()
                });
            }

            logError(error, context) {
                this.log('FRONTEND_ERROR', {
                    error: error.toString(),
                    context: context,
                    stack: error.stack,
                    timestamp: Date.now()
                });
            }
        }

        // 初始化前端視覺日誌記錄器
        let frontendLogger;
        try {
            frontendLogger = new FrontendVisualLogger();
            console.log("✅ Frontend logger initialized successfully");
        } catch (error) {
            console.error("❌ Failed to initialize frontend logger:", error);
            // 創建一個 dummy logger 以避免錯誤
            frontendLogger = {
                generateObservationId: () => `obs_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`,
                logPageLoad: () => { },
                logError: () => { },
                logEyesCapture: () => { },
                logEyesPrompt: () => { },
                logEyesTransfer: () => { },
                logUserAction: () => { },
                log: () => { }
            };
        }

        // 記錄頁面載入
        window.addEventListener('load', () => {
            try {
                frontendLogger.logPageLoad();
            } catch (error) {
                console.warn("⚠️ Page load logging failed:", error);
            }
        });

        // 記錄未捕獲的錯誤
        window.addEventListener('error', (event) => {
            try {
                if (frontendLogger && frontendLogger.logError) {
                    frontendLogger.logError(event.error, 'uncaught_error');
                }
            } catch (logError) {
                console.warn("⚠️ Error logging failed:", logError);
            }
        });

        // Create a simplified modular structure that works
        class ConfigManager {
            constructor() {
                this.baseURL = "http://localhost:8000";
                this.config = null;
            }

            async loadConfig() {
                try {
                    const res = await fetch(this.baseURL + "/config", {
                        signal: AbortSignal.timeout(3000)
                    });

                    if (!res.ok) throw new Error("Failed to load configuration");

                    this.config = await res.json();
                    return this.config;
                } catch (error) {
                    console.error("Failed to load config:", error);
                    return null;
                }
            }

            getConfig() {
                return this.config;
            }
        }

        class APIClient {
            constructor() {
                this.baseURL = "http://localhost:8000";
            }

            async checkStatus() {
                try {
                    const res = await fetch(this.baseURL + "/status", {
                        signal: AbortSignal.timeout(5000)
                    });

                    if (res.ok) {
                        return await res.json();
                    } else {
                        throw new Error(`HTTP ${res.status}`);
                    }
                } catch (error) {
                    throw error;
                }
            }

            async sendChatCompletion(instruction, imageResult, maxTokens = 100) {
                // 處理圖像數據：可能是字符串（舊格式）或對象（新格式）
                let imageBase64URL, observationId;
                
                if (typeof imageResult === 'string') {
                    // 舊格式：直接是 base64 字符串
                    imageBase64URL = imageResult;
                    observationId = frontendLogger && frontendLogger.generateObservationId ? 
                        frontendLogger.generateObservationId() : 
                        `obs_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
                } else if (imageResult && typeof imageResult === 'object') {
                    // 新格式：包含 dataURL 和 ID 的對象
                    imageBase64URL = imageResult.dataURL;
                    observationId = imageResult.observationId;
                } else {
                    throw new Error('Invalid image data format');
                }

                // 記錄視覺提示詞
                try {
                    if (frontendLogger && frontendLogger.logEyesPrompt) {
                        frontendLogger.logEyesPrompt(observationId, instruction);
                    }
                } catch (error) {
                    console.warn("⚠️ Failed to log eyes prompt:", error);
                }

                const requestBody = {
                    max_tokens: maxTokens,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                { type: 'text', text: instruction },
                                { type: 'image_url', image_url: { url: imageBase64URL } }
                            ]
                        }
                    ]
                };

                // 記錄後端傳輸（不包含實際圖像數據以避免日誌過大）
                try {
                    if (frontendLogger && frontendLogger.logEyesTransfer) {
                        frontendLogger.logEyesTransfer(observationId, {
                            max_tokens: maxTokens,
                            instruction_length: instruction.length,
                            has_image: true,
                            image_format: imageBase64URL.split(';')[0].replace('data:image/', ''),
                            request_size_estimate: `${Math.round(JSON.stringify(requestBody).length / 1024)}KB`
                        });
                    }
                } catch (error) {
                    console.warn("⚠️ Failed to log eyes transfer:", error);
                }

                const response = await fetch(`${this.baseURL}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: AbortSignal.timeout(30000)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    // 記錄API錯誤
                    try {
                        if (frontendLogger && frontendLogger.logError) {
                            frontendLogger.logError(new Error(`Server error: ${response.status} - ${errorText}`), 'api_request');
                        }
                    } catch (logError) {
                        console.warn("⚠️ Failed to log API error:", logError);
                    }
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                let data;
                try {
                    const responseText = await response.text();
                    console.log('Raw API response:', responseText);
                    
                    if (!responseText || responseText.trim() === '' || responseText.trim() === 'null') {
                        throw new Error(`API returned empty or null response: "${responseText}"`);
                    }
                    
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse API response:', parseError);
                    throw new Error(`Invalid JSON response from API: ${parseError.message}`);
                }

                // 驗證 API 回應格式
                if (!data) {
                    throw new Error('API returned null or undefined data after parsing');
                }

                if (!data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
                    console.error('Invalid API response format:', data);
                    throw new Error(`Invalid API response format. Expected choices array, got: ${JSON.stringify(data)}`);
                }

                if (!data.choices[0].message || !data.choices[0].message.content) {
                    console.error('Invalid message format in API response:', data.choices[0]);
                    throw new Error('Invalid message format in API response');
                }

                const content = data.choices[0].message.content;

                // 記錄API回應（不包含完整內容以避免日誌過大）
                try {
                    if (frontendLogger && frontendLogger.log) {
                        frontendLogger.log('API_RESPONSE', {
                            observation_id: observationId,
                            status: response.status,
                            response_length: content.length,
                            has_content: !!content,
                            timestamp: Date.now()
                        });
                    }
                } catch (error) {
                    console.warn("⚠️ Failed to log API response:", error);
                }

                return content;
            }
        }

        class CameraManager {
            constructor() {
                this.stream = null;
                this.video = document.getElementById('videoFeed');
                this.canvas = document.getElementById('canvas');
                this.cameraSelect = document.getElementById('cameraSelect');
            }

            async populateCameraList() {
                try {
                    await navigator.mediaDevices.getUserMedia({ video: true, audio: false });

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');

                    if (videoDevices.length === 0) {
                        throw new Error("No cameras found");
                    }

                    this.cameraSelect.innerHTML = videoDevices.map(device => {
                        const isIPhone = device.label.toLowerCase().includes('continuity') ||
                            device.label.toLowerCase().includes('iphone');
                        const isMacBook = device.label.toLowerCase().includes('facetime') ||
                            device.label.toLowerCase().includes('built-in');
                        const isExternal = device.label.toLowerCase().includes('usb') ||
                            device.label.toLowerCase().includes('capture');

                        let icon = '📷 ';
                        if (isIPhone) icon = '📱 ';
                        else if (isMacBook) icon = '💻 ';
                        else if (isExternal) icon = '🎥 ';

                        const label = device.label || `Camera ${videoDevices.indexOf(device) + 1}`;
                        return `<option value="${device.deviceId}">${icon}${label}</option>`;
                    }).join('');

                    const macBookCamera = videoDevices.find(d =>
                        d.label.toLowerCase().includes('facetime') ||
                        d.label.toLowerCase().includes('built-in')
                    );

                    const selectedCamera = macBookCamera || videoDevices[0];
                    this.cameraSelect.value = selectedCamera.deviceId;
                    await this.startCamera(selectedCamera.deviceId);

                } catch (err) {
                    console.error("Error accessing cameras:", err);
                    throw err;
                }
            }

            async startCamera(deviceId) {
                try {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                    }

                    const constraints = {
                        video: {
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            facingMode: deviceId ? undefined : "user"
                        },
                        audio: false
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;

                    // 等待視頻元數據加載完成
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Video metadata loading timeout'));
                        }, 10000); // 10秒超時

                        this.video.onloadedmetadata = () => {
                            clearTimeout(timeout);
                            this.video.classList.add('animate-fade-in');
                            console.log(`Camera started: ${this.video.videoWidth}x${this.video.videoHeight}`);
                            resolve();
                        };

                        this.video.onerror = (error) => {
                            clearTimeout(timeout);
                            reject(error);
                        };
                    });

                } catch (err) {
                    console.error("Error starting camera:", err);
                    throw err;
                }
            }

            captureImage(quality = 0.9) {
                console.log("🎥 Starting image capture...");

                // 檢查攝像頭流是否存在
                if (!this.stream) {
                    console.error("❌ No camera stream available");
                    return null;
                }
                console.log("✅ Camera stream exists");

                // 檢查視頻元素是否準備就緒
                if (!this.video || this.video.readyState < 2) {
                    console.error("❌ Video not ready, readyState:", this.video ? this.video.readyState : 'video element not found');
                    return null;
                }
                console.log("✅ Video element ready, readyState:", this.video.readyState);

                // 等待視頻尺寸可用
                if (!this.video.videoWidth || !this.video.videoHeight) {
                    console.error("❌ Video dimensions not available:", this.video.videoWidth, 'x', this.video.videoHeight);
                    return null;
                }
                console.log("✅ Video dimensions:", this.video.videoWidth, 'x', this.video.videoHeight);

                try {
                    console.log("🔄 Starting capture process...");

                    // 生成觀察ID和請求ID
                    let observationId;
                    try {
                        observationId = (typeof frontendLogger !== 'undefined' && frontendLogger.generateObservationId)
                            ? frontendLogger.generateObservationId()
                            : `obs_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
                    } catch (idError) {
                        console.warn("⚠️ ID generation failed, using fallback:", idError);
                        observationId = `obs_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
                    }

                    const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
                    console.log("✅ Generated IDs:", { observationId, requestId });

                    const targetWidth = 1024;
                    const aspectRatio = this.video.videoHeight / this.video.videoWidth;
                    const targetHeight = Math.round(targetWidth * aspectRatio);
                    console.log("✅ Target dimensions:", targetWidth, 'x', targetHeight);

                    // 檢查 canvas 元素
                    if (!this.canvas) {
                        console.error("❌ Canvas element not found");
                        return null;
                    }

                    this.canvas.width = targetWidth;
                    this.canvas.height = targetHeight;
                    console.log("✅ Canvas dimensions set");

                    const ctx = this.canvas.getContext('2d');
                    if (!ctx) {
                        console.error("❌ Failed to get canvas 2D context");
                        return null;
                    }
                    console.log("✅ Canvas context obtained");

                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';

                    // 嘗試繪製視頻幀到 canvas
                    try {
                        ctx.drawImage(this.video, 0, 0, targetWidth, targetHeight);
                        console.log("✅ Video frame drawn to canvas");
                    } catch (drawError) {
                        console.error("❌ Failed to draw video to canvas:", drawError);
                        return null;
                    }

                    const imageQuality = Math.max(0.92, parseFloat(quality) || 0.9);
                    console.log("✅ Image quality set to:", imageQuality);

                    // 嘗試轉換為 data URL
                    let imageDataURL;
                    try {
                        imageDataURL = this.canvas.toDataURL('image/jpeg', imageQuality);
                        console.log("✅ Canvas converted to data URL, length:", imageDataURL.length);
                    } catch (dataUrlError) {
                        console.error("❌ Failed to convert canvas to data URL:", dataUrlError);
                        return null;
                    }

                    // 驗證生成的圖像數據
                    if (!imageDataURL || imageDataURL.length < 100) {
                        console.error("❌ Generated image data is invalid or too small, length:", imageDataURL ? imageDataURL.length : 0);
                        return null;
                    }

                    // 檢查是否是有效的 JPEG data URL
                    if (!imageDataURL.startsWith('data:image/jpeg;base64,')) {
                        console.error("❌ Generated data URL has invalid format:", imageDataURL.substring(0, 50));
                        return null;
                    }
                    console.log("✅ Image data validation passed");

                    // 獲取設備資訊
                    const selectedOption = this.cameraSelect.options[this.cameraSelect.selectedIndex];
                    const deviceInfo = {
                        device: selectedOption ? selectedOption.text : 'Unknown Camera'
                    };

                    // 計算圖像大小
                    const imageSizeBytes = Math.round((imageDataURL.length - 'data:image/jpeg;base64,'.length) * 3 / 4);

                    // 記錄圖像捕獲事件
                    try {
                        if (typeof frontendLogger !== 'undefined' && frontendLogger.logEyesCapture) {
                            frontendLogger.logEyesCapture(observationId, requestId, deviceInfo, {
                                resolution: `${targetWidth}x${targetHeight}`,
                                quality: imageQuality,
                                format: 'jpeg',
                                size: `${(imageSizeBytes / 1024).toFixed(1)}KB`
                            });
                            console.log("✅ Logging completed");
                        } else {
                            console.log("⚠️ Frontend logger not available, skipping logging");
                        }
                    } catch (logError) {
                        console.warn("⚠️ Logging failed but continuing:", logError);
                    }

                    // 創建一個包含圖像數據和ID的對象
                    const imageResult = {
                        dataURL: imageDataURL,
                        observationId: observationId,
                        requestId: requestId,
                        width: targetWidth,
                        height: targetHeight,
                        size: imageSizeBytes
                    };

                    console.log(`🎉 Image captured successfully: ${targetWidth}x${targetHeight}, ${(imageSizeBytes / 1024).toFixed(1)}KB`);
                    return imageResult;

                } catch (err) {
                    console.error("❌ Error in capture process:", err);
                    console.error("❌ Error stack:", err.stack);

                    try {
                        if (typeof frontendLogger !== 'undefined' && frontendLogger.logError) {
                            frontendLogger.logError(err, 'image_capture');
                        }
                    } catch (logError) {
                        console.warn("⚠️ Error logging failed:", logError);
                    }

                    return null;
                }
            }

            cleanup() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
            }
        }

        class UIManager {
            constructor() {
                this.elements = {
                    apiStatusDot: document.getElementById('apiStatusDot'),
                    apiStatusText: document.getElementById('apiStatusText'),
                    activeModel: document.getElementById('activeModel'),
                    systemStatus: document.getElementById('systemStatus'),
                    modelDesc: document.getElementById('modelDesc'),
                    errorMsg: document.getElementById('errorMsg'),
                    modelHelp: document.getElementById('modelHelp'),
                    instructionText: document.getElementById('instructionText'),
                    responseText: document.getElementById('responseText'),
                    startButton: document.getElementById('startButton'),
                    imagePreview: document.getElementById('imagePreview'),
                    captureLabel: document.querySelector('.capture-label'),
                    intervalSelect: document.getElementById('intervalSelect'),
                    qualitySelect: document.getElementById('qualitySelect'),
                    tokensSelect: document.getElementById('tokensSelect'),
                    cameraSelect: document.getElementById('cameraSelect')
                };
            }

            updateApiStatusOnline(data) {
                this.elements.apiStatusDot.className = "status-dot online";
                this.elements.apiStatusText.textContent = "API Online";

                const modelName = data.model_status?.name || data.active_model || "Unknown";
                this.elements.activeModel.textContent = modelName;

                const availableModels = data.available_models && data.available_models.length
                    ? data.available_models.join(", ")
                    : "None";

                this.elements.systemStatus.innerHTML = `
                    <div style="margin-bottom: 0.75rem;"><strong>Status:</strong> <span style="color: var(--success);">Connected</span></div>
                    <div style="margin-bottom: 0.75rem;"><strong>Active Model:</strong> ${modelName}</div>
                    <div style="margin-bottom: 0.75rem;"><strong>Version:</strong> ${data.model_status?.version || "N/A"}</div>
                    <div><strong>Available Models:</strong> ${availableModels}</div>
                `;

                if (data.model_status?.description) {
                    const modelInfoDiv = document.querySelector('.model-info');
                    if (modelInfoDiv) {
                        const featureList = modelInfoDiv.querySelector('.feature-list');
                        modelInfoDiv.innerHTML = `
                            <h4>${modelName}</h4>
                            <p>${data.model_status.description}</p>
                            ${featureList ? featureList.outerHTML : ''}
                        `;
                    }
                }
            }

            updateApiStatusOffline() {
                this.elements.apiStatusDot.className = "status-dot offline";
                this.elements.apiStatusText.textContent = "Backend Offline";
                this.elements.activeModel.textContent = "Camera Only Mode";

                this.elements.systemStatus.innerHTML = `
                    <div style="color: var(--warning);"><i class="fas fa-info-circle"></i> Backend Not Connected</div>
                    <div style="margin-top: 0.75rem;">Please start the backend server on port 8000</div>
                    <div style="margin-top: 0.5rem;">Camera functionality works without backend.</div>
                `;
            }

            showError(message) {
                this.elements.errorMsg.textContent = message;
                this.elements.errorMsg.style.display = "block";
            }

            hideError() {
                this.elements.errorMsg.style.display = "none";
            }

            updateImagePreview(dataUrl) {
                if (!dataUrl) return;

                this.elements.imagePreview.src = dataUrl;
                this.elements.imagePreview.style.display = "inline-block";

                if (this.elements.captureLabel) {
                    this.elements.captureLabel.innerHTML = `Frame sent to AI<br><span style="font-size: 0.65rem;">${new Date().toLocaleTimeString()}</span>`;
                    this.elements.captureLabel.style.backgroundColor = "var(--success-light)";
                    this.elements.captureLabel.style.color = "var(--success)";

                    setTimeout(() => {
                        this.elements.captureLabel.style.backgroundColor = "";
                        this.elements.captureLabel.style.color = "";
                    }, 2000);
                }

                this.elements.imagePreview.classList.remove('animate-fade-in');
                void this.elements.imagePreview.offsetWidth;
                this.elements.imagePreview.classList.add('animate-fade-in');
            }

            updateProcessingState(isProcessing) {
                if (isProcessing) {
                    this.elements.startButton.innerHTML = '<i class="fas fa-stop"></i><span>Stop</span>';
                    this.elements.startButton.classList.add('btn-danger');
                    this.elements.startButton.classList.remove('btn-primary');

                    this.elements.instructionText.disabled = true;
                    this.elements.intervalSelect.disabled = true;
                    this.elements.qualitySelect.disabled = true;
                    this.elements.tokensSelect.disabled = true;
                    this.elements.cameraSelect.disabled = true;

                    this.elements.responseText.value = "";
                } else {
                    this.elements.startButton.innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
                    this.elements.startButton.classList.add('btn-primary');
                    this.elements.startButton.classList.remove('btn-danger');

                    this.elements.instructionText.disabled = false;
                    this.elements.intervalSelect.disabled = false;
                    this.elements.qualitySelect.disabled = false;
                    this.elements.tokensSelect.disabled = false;
                    this.elements.cameraSelect.disabled = false;
                }
            }
        }

        class TabManager {
            constructor() {
                this.setupTabs();
            }

            setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-btn');

                tabButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetId = btn.getAttribute('data-target');
                        const targetPanel = document.getElementById(targetId);

                        // Hide all panels
                        document.querySelectorAll('.tab-panel').forEach(panel => {
                            panel.style.display = 'none';
                            panel.classList.remove('active');
                        });

                        // Show target panel
                        if (targetPanel) {
                            targetPanel.style.display = 'block';
                            targetPanel.classList.add('active');
                        }

                        // Update tab button styles
                        tabButtons.forEach(b => {
                            b.classList.remove('active-tab');
                            b.style.opacity = '0.6';
                            b.style.borderBottom = 'none';
                        });

                        // Set active tab style
                        btn.classList.add('active-tab');
                        btn.style.opacity = '1';
                        btn.style.borderBottom = '2px solid var(--primary)';
                    });
                });
            }
        }

        // Main VisionApp class
        class VisionApp {
            constructor() {
                this.managers = {
                    config: new ConfigManager(),
                    api: new APIClient(),
                    camera: new CameraManager(),
                    ui: new UIManager(),
                    tabs: new TabManager()
                };

                this.isProcessing = false;
                this.intervalId = null;
            }

            getManager(name) {
                return this.managers[name];
            }

            async initialize() {
                try {
                    console.log('🚀 Initializing Vision Intelligence Hub...');

                    // Initialize camera
                    await this.managers.camera.populateCameraList();

                    // Try to connect to backend
                    await Promise.allSettled([
                        this.checkApiStatus(),
                        this.loadConfig()
                    ]);

                    // Setup event listeners
                    this.setupEventListeners();

                    // Initialize UI
                    if (this.managers.ui.elements.captureLabel) {
                        this.managers.ui.elements.captureLabel.innerHTML = `<span style="color: var(--text);">Click Start to begin<br>Camera ready for analysis</span>`;
                    }

                    console.log('✅ Application initialized successfully');

                } catch (error) {
                    console.error('❌ Failed to initialize application:', error);
                    this.managers.ui.showError('Application initialization had some issues, but camera should still work.');
                }
            }

            async checkApiStatus() {
                try {
                    const data = await this.managers.api.checkStatus();
                    this.managers.ui.updateApiStatusOnline(data);
                } catch (error) {
                    this.managers.ui.updateApiStatusOffline();
                }
            }

            async loadConfig() {
                try {
                    const config = await this.managers.config.loadConfig();

                    if (config?.model_help) {
                        this.managers.ui.elements.modelHelp.style.display = "block";
                        this.managers.ui.elements.modelHelp.textContent = config.model_help;
                    } else {
                        this.managers.ui.elements.modelHelp.style.display = "block";
                        this.managers.ui.elements.modelHelp.textContent = "Camera is ready. Enter a question about what you want to analyze in the image.";
                    }

                    if (config?.default_instruction) {
                        this.managers.ui.elements.instructionText.value = config.default_instruction;
                    }

                    if (config?.capture_intervals && Array.isArray(config.capture_intervals)) {
                        this.managers.ui.elements.intervalSelect.innerHTML = config.capture_intervals.map(interval =>
                            `<option value="${interval}">${interval / 1000}s</option>`
                        ).join('');
                    }
                } catch (error) {
                    console.error("Failed to load config:", error);
                    this.managers.ui.elements.modelHelp.style.display = "block";
                    this.managers.ui.elements.modelHelp.textContent = "Camera is ready. Backend connection required for AI analysis.";
                }
            }

            setupEventListeners() {
                this.managers.ui.elements.startButton.addEventListener('click', () => {
                    if (this.isProcessing) {
                        this.handleStop();
                    } else {
                        this.handleStart();
                    }
                });

                this.managers.ui.elements.instructionText.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        if (this.isProcessing) {
                            this.handleStop();
                        } else {
                            this.handleStart();
                        }
                    }
                });

                this.managers.ui.elements.cameraSelect.addEventListener('change', async () => {
                    const selectedDeviceId = this.managers.ui.elements.cameraSelect.value;
                    const selectedOption = this.managers.ui.elements.cameraSelect.options[this.managers.ui.elements.cameraSelect.selectedIndex];

                    // 記錄攝像頭切換
                    try {
                        if (frontendLogger && frontendLogger.logUserAction) {
                            frontendLogger.logUserAction('camera_change', {
                                device_id: selectedDeviceId,
                                device_name: selectedOption ? selectedOption.text : 'Unknown'
                            });
                        }
                    } catch (error) {
                        console.warn("⚠️ Failed to log camera change:", error);
                    }

                    await this.managers.camera.startCamera(selectedDeviceId);
                });

                navigator.mediaDevices.addEventListener('devicechange', async () => {
                    console.log('Camera devices changed');

                    // 記錄設備變更
                    try {
                        if (frontendLogger && frontendLogger.logUserAction) {
                            frontendLogger.logUserAction('device_change', {
                                event: 'camera_devices_changed'
                            });
                        }
                    } catch (error) {
                        console.warn("⚠️ Failed to log device change:", error);
                    }

                    await this.managers.camera.populateCameraList();
                });

                // 記錄設置變更
                this.managers.ui.elements.intervalSelect.addEventListener('change', () => {
                    try {
                        if (frontendLogger && frontendLogger.logUserAction) {
                            frontendLogger.logUserAction('setting_change', {
                                setting: 'capture_interval',
                                value: this.managers.ui.elements.intervalSelect.value
                            });
                        }
                    } catch (error) {
                        console.warn("⚠️ Failed to log interval change:", error);
                    }
                });

                this.managers.ui.elements.qualitySelect.addEventListener('change', () => {
                    try {
                        if (frontendLogger && frontendLogger.logUserAction) {
                            frontendLogger.logUserAction('setting_change', {
                                setting: 'image_quality',
                                value: this.managers.ui.elements.qualitySelect.value
                            });
                        }
                    } catch (error) {
                        console.warn("⚠️ Failed to log quality change:", error);
                    }
                });

                this.managers.ui.elements.tokensSelect.addEventListener('change', () => {
                    try {
                        if (frontendLogger && frontendLogger.logUserAction) {
                            frontendLogger.logUserAction('setting_change', {
                                setting: 'max_tokens',
                                value: this.managers.ui.elements.tokensSelect.value
                            });
                        }
                    } catch (error) {
                        console.warn("⚠️ Failed to log tokens change:", error);
                    }
                });
            }

            handleStart() {
                // 檢查攝像頭流
                if (!this.managers.camera.stream) {
                    this.managers.ui.showError("Camera not available. Please check permissions and try refreshing the page.");
                    return;
                }

                // 檢查視頻元素狀態
                const video = this.managers.camera.video;
                if (!video || video.readyState < 2) {
                    this.managers.ui.showError("Camera is still loading. Please wait a moment and try again.");
                    return;
                }

                // 檢查視頻尺寸
                if (!video.videoWidth || !video.videoHeight) {
                    this.managers.ui.showError("Camera video dimensions not ready. Please wait a moment and try again.");
                    return;
                }

                // 檢查指令
                const instruction = this.managers.ui.elements.instructionText.value.trim();
                if (!instruction) {
                    this.managers.ui.showError("Please enter an instruction before starting.");
                    return;
                }

                // 記錄用戶開始操作
                const intervalTime = this.getValidCaptureInterval();
                try {
                    if (frontendLogger && frontendLogger.logUserAction) {
                        frontendLogger.logUserAction('start_processing', {
                            instruction: instruction,
                            capture_interval: intervalTime,
                            quality: this.managers.ui.elements.qualitySelect.value,
                            max_tokens: this.managers.ui.elements.tokensSelect.value,
                            video_ready: video.readyState,
                            video_dimensions: `${video.videoWidth}x${video.videoHeight}`
                        });
                    }
                } catch (error) {
                    console.warn("⚠️ Failed to log start processing:", error);
                }

                this.isProcessing = true;
                this.managers.ui.updateProcessingState(true);

                // 延遲一點點確保一切準備就緒
                setTimeout(() => {
                    this.sendData();

                    if (this.managers.ui.elements.captureLabel) {
                        this.managers.ui.elements.captureLabel.innerHTML = `Processing starts<br>Capture every ${intervalTime / 1000}s`;
                    }

                    this.intervalId = setInterval(() => this.sendData(), intervalTime);
                }, 100);
            }

            handleStop() {
                // 記錄用戶停止操作
                try {
                    if (frontendLogger && frontendLogger.logUserAction) {
                        frontendLogger.logUserAction('stop_processing', {
                            reason: 'user_initiated'
                        });
                    }
                } catch (error) {
                    console.warn("⚠️ Failed to log stop processing:", error);
                }

                this.isProcessing = false;
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }

                this.managers.ui.updateProcessingState(false);

                if (this.managers.ui.elements.captureLabel) {
                    this.managers.ui.elements.captureLabel.innerHTML = `<span style="color: var(--text);">Click Start to begin<br>Camera ready for analysis</span>`;
                    this.managers.ui.elements.captureLabel.style.backgroundColor = "";
                    this.managers.ui.elements.captureLabel.style.color = "";
                }
            }

            async sendData() {
                if (!this.isProcessing) return;

                if (window.currentRequestProcessing) {
                    console.log("⏳ Previous request still processing, skipping this one");
                    return;
                }

                this.managers.ui.hideError();

                const instruction = this.managers.ui.elements.instructionText.value.trim();
                if (!instruction) {
                    this.managers.ui.showError("Please enter an instruction before starting.");
                    this.handleStop();
                    return;
                }

                const quality = this.managers.ui.elements.qualitySelect.value;
                console.log("🎬 Attempting to capture image with quality:", quality);

                const imageBase64URL = this.managers.camera.captureImage(quality);
                if (!imageBase64URL) {
                    const video = this.managers.camera.video;
                    const stream = this.managers.camera.stream;
                    const canvas = this.managers.camera.canvas;

                    console.error("❌ Image capture returned null, diagnosing...");

                    let errorDetails = "Detailed diagnosis: ";
                    let diagnosticInfo = [];

                    // 基本檢查
                    if (!stream) {
                        errorDetails += "No camera stream. ";
                        diagnosticInfo.push("stream: null");
                    } else {
                        diagnosticInfo.push("stream: exists");
                        diagnosticInfo.push(`stream.active: ${stream.active}`);
                        diagnosticInfo.push(`stream.tracks: ${stream.getTracks().length}`);
                    }

                    if (!video) {
                        errorDetails += "Video element not found. ";
                        diagnosticInfo.push("video: null");
                    } else {
                        diagnosticInfo.push("video: exists");
                        diagnosticInfo.push(`video.readyState: ${video.readyState}`);
                        diagnosticInfo.push(`video.dimensions: ${video.videoWidth}x${video.videoHeight}`);
                        diagnosticInfo.push(`video.srcObject: ${!!video.srcObject}`);
                        diagnosticInfo.push(`video.paused: ${video.paused}`);
                        diagnosticInfo.push(`video.ended: ${video.ended}`);

                        if (video.readyState < 2) {
                            errorDetails += `Video not ready (state: ${video.readyState}). `;
                        } else if (!video.videoWidth || !video.videoHeight) {
                            errorDetails += `Video dimensions invalid (${video.videoWidth}x${video.videoHeight}). `;
                        }
                    }

                    if (!canvas) {
                        errorDetails += "Canvas element not found. ";
                        diagnosticInfo.push("canvas: null");
                    } else {
                        diagnosticInfo.push("canvas: exists");
                        diagnosticInfo.push(`canvas.dimensions: ${canvas.width}x${canvas.height}`);

                        const ctx = canvas.getContext('2d');
                        diagnosticInfo.push(`canvas.context: ${!!ctx}`);
                    }

                    // 如果所有基本檢查都通過，說明是內部錯誤
                    if (stream && video && video.readyState >= 2 && video.videoWidth && video.videoHeight && canvas) {
                        errorDetails += "Internal capture error (check console for details). ";
                    }

                    console.error("🔍 Diagnostic info:", diagnosticInfo.join(", "));

                    this.managers.ui.showError(`Unable to capture image. ${errorDetails}Check browser console for detailed logs.`);

                    // 記錄詳細錯誤信息
                    try {
                        if (typeof frontendLogger !== 'undefined' && frontendLogger.logError) {
                            frontendLogger.logError(new Error(`Image capture failed: ${errorDetails} Diagnostics: ${diagnosticInfo.join(", ")}`), 'image_capture_detailed');
                        }
                    } catch (logError) {
                        console.warn("⚠️ Error logging failed:", logError);
                    }

                    // 自動停止處理
                    this.handleStop();
                    return;
                }

                // 獲取觀察ID（從圖像捕獲中獲得）
                const observationId = imageBase64URL.observationId;
                const requestId = imageBase64URL.requestId;

                window.currentRequestProcessing = true;

                try {
                    this.managers.ui.updateImagePreview(imageBase64URL.dataURL);

                    const maxTokens = parseInt(this.managers.ui.elements.tokensSelect.value) || 100;

                    const response = await this.managers.api.sendChatCompletion(instruction, imageBase64URL, maxTokens);

                    this.managers.ui.elements.responseText.value = response || "No response received";

                } catch (error) {
                    this.managers.ui.showError(error.message);
                    try {
                        if (frontendLogger && frontendLogger.logError) {
                            frontendLogger.logError(error, 'vlm_request');
                        }
                    } catch (logError) {
                        console.warn("⚠️ Failed to log VLM request error:", logError);
                    }
                } finally {
                    window.currentRequestProcessing = false;
                }
            }

            getValidCaptureInterval() {
                const defaultInterval = 2000;
                const intervalValue = this.managers.ui.elements.intervalSelect.value;

                if (!intervalValue || intervalValue === "none") {
                    return defaultInterval;
                }

                const intervalTime = parseInt(intervalValue, 10);
                if (isNaN(intervalTime) || intervalTime < 100) {
                    return defaultInterval;
                }

                return intervalTime;
            }

            cleanup() {
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                }
                this.managers.camera.cleanup();
            }
        }

        // Initialize the application
        let app;

        async function initializeApp() {
            try {
                console.log('🚀 Initializing Vision Intelligence Hub...');

                // Create main application instance
                app = new VisionApp();

                // Start the application
                await app.initialize();

                console.log('✅ Application initialized successfully');

                // Set up global error handling
                window.addEventListener('error', (event) => {
                    console.error('❌ Global error:', event.error);
                    const uiManager = app.getManager('ui');
                    if (uiManager) {
                        uiManager.showError('An unexpected error occurred. Please refresh the page.');
                    }
                });

                // Set up unload cleanup
                window.addEventListener('beforeunload', () => {
                    if (app) {
                        app.cleanup();
                    }
                });

                // Retry API connection periodically when offline
                setInterval(() => {
                    const apiStatusDot = document.getElementById('apiStatusDot');
                    if (apiStatusDot && apiStatusDot.classList.contains('offline')) {
                        app.checkApiStatus();
                    }
                }, 30000);

            } catch (error) {
                console.error('❌ Failed to initialize application:', error);

                // Fallback error display
                const errorMsg = document.getElementById('errorMsg');
                if (errorMsg) {
                    errorMsg.textContent = 'Failed to initialize application. Please refresh the page.';
                    errorMsg.style.display = 'block';
                }
            }
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Export for debugging
        window.visionApp = () => app;
    </script>
</body>

</html>