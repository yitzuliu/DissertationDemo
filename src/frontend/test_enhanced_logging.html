<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ—¥èªŒç³»çµ±å¢å¼·æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .log-output {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .success {
            color: #27ae60;
        }
        .error {
            color: #e74c3c;
        }
        .info {
            color: #3498db;
        }
        input, select, textarea {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        textarea {
            width: 300px;
            height: 60px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å‰ç«¯è¦–è¦ºæ—¥èªŒç³»çµ±å¢å¼·æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h3>ğŸ“¸ EYES_CAPTURE æ—¥èªŒæ¸¬è©¦</h3>
            <p>æ¸¬è©¦åœ–åƒæ•ç²æ—¥èªŒè¨˜éŒ„åŠŸèƒ½</p>
            <button onclick="testEyesCapture()">æ¸¬è©¦åœ–åƒæ•ç²æ—¥èªŒ</button>
            <button onclick="testMultipleCaptures()">æ¸¬è©¦å¤šæ¬¡æ•ç²</button>
        </div>

        <div class="test-section">
            <h3>ğŸ’¬ EYES_PROMPT æ—¥èªŒæ¸¬è©¦</h3>
            <p>æ¸¬è©¦è¦–è¦ºæç¤ºè©æ—¥èªŒè¨˜éŒ„åŠŸèƒ½</p>
            <textarea id="testPrompt" placeholder="è¼¸å…¥æ¸¬è©¦æç¤ºè©...">æè¿°é€™å¼µåœ–ç‰‡ä¸­çš„å…§å®¹</textarea><br>
            <button onclick="testEyesPrompt()">æ¸¬è©¦æç¤ºè©æ—¥èªŒ</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“¤ EYES_TRANSFER æ—¥èªŒæ¸¬è©¦</h3>
            <p>æ¸¬è©¦å¾Œç«¯å‚³è¼¸æ—¥èªŒè¨˜éŒ„åŠŸèƒ½</p>
            <select id="testQuality">
                <option value="0.7">å¿«é€Ÿ (0.7)</option>
                <option value="0.8">ä¸­ç­‰ (0.8)</option>
                <option value="0.9" selected>é«˜å“è³ª (0.9)</option>
            </select>
            <select id="testTokens">
                <option value="100" selected>100 tokens</option>
                <option value="200">200 tokens</option>
                <option value="300">300 tokens</option>
            </select>
            <button onclick="testEyesTransfer()">æ¸¬è©¦å‚³è¼¸æ—¥èªŒ</button>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¤ ç”¨æˆ¶æ“ä½œæ—¥èªŒæ¸¬è©¦</h3>
            <p>æ¸¬è©¦ç”¨æˆ¶æ“ä½œæ—¥èªŒè¨˜éŒ„åŠŸèƒ½</p>
            <button onclick="testUserActions()">æ¸¬è©¦ç”¨æˆ¶æ“ä½œ</button>
            <button onclick="testSettingChanges()">æ¸¬è©¦è¨­ç½®è®Šæ›´</button>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ å®Œæ•´æµç¨‹æ¸¬è©¦</h3>
            <p>æ¸¬è©¦å®Œæ•´çš„è¦–è¦ºè™•ç†æµç¨‹æ—¥èªŒ</p>
            <button onclick="testCompleteFlow()">æ¸¬è©¦å®Œæ•´æµç¨‹</button>
            <button onclick="testErrorScenarios()">æ¸¬è©¦éŒ¯èª¤å ´æ™¯</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ—¥èªŒçµ±è¨ˆèˆ‡é©—è­‰</h3>
            <p>æª¢æŸ¥æ—¥èªŒè¨˜éŒ„çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§</p>
            <button onclick="validateLogs()">é©—è­‰æ—¥èªŒå®Œæ•´æ€§</button>
            <button onclick="showLogStats()">é¡¯ç¤ºæ—¥èªŒçµ±è¨ˆ</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        </div>

        <div class="log-output" id="logOutput">
            <div class="info">ğŸ“‹ æ—¥èªŒè¼¸å‡ºå°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
        </div>
    </div>

    <script>
        // å¾ä¸»æ–‡ä»¶ä¸­æå–çš„å¢å¼·ç‰ˆå‰ç«¯è¦–è¦ºæ—¥èªŒè¨˜éŒ„å™¨
        class FrontendVisualLogger {
            constructor() {
                this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.logToConsole = true;
                this.logToServer = false;
                this.observationId = null;
                this.logs = []; // å­˜å„²æ—¥èªŒç”¨æ–¼æ¸¬è©¦
            }
            
            generateObservationId() {
                const timestamp = Date.now();
                this.observationId = `obs_${timestamp}_${Math.random().toString(36).substr(2, 8)}`;
                return this.observationId;
            }
            
            log(eventType, data) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId,
                    eventType: eventType,
                    data: data
                };
                
                // å­˜å„²æ—¥èªŒç”¨æ–¼æ¸¬è©¦
                this.logs.push(logEntry);
                
                if (this.logToConsole) {
                    console.log(`[FrontendVisualLog] ${eventType}:`, data);
                }
                
                // é¡¯ç¤ºåœ¨é é¢ä¸Š
                this.displayLog(eventType, data);
            }
            
            displayLog(eventType, data) {
                const output = document.getElementById('logOutput');
                const timestamp = new Date().toLocaleTimeString();
                const logHtml = `
                    <div class="success">
                        [${timestamp}] ${eventType}: ${JSON.stringify(data, null, 2)}
                    </div>
                `;
                output.innerHTML += logHtml;
                output.scrollTop = output.scrollHeight;
            }
            
            logEyesCapture(observationId, requestId, deviceInfo, imageData) {
                this.log('EYES_CAPTURE', {
                    observation_id: observationId,
                    request_id: requestId,
                    device: deviceInfo.device,
                    resolution: imageData.resolution,
                    quality: imageData.quality,
                    format: imageData.format,
                    size: imageData.size,
                    timestamp: Date.now()
                });
            }
            
            logEyesPrompt(observationId, prompt) {
                this.log('EYES_PROMPT', {
                    observation_id: observationId,
                    prompt: prompt,
                    length: prompt.length,
                    timestamp: Date.now()
                });
            }
            
            logEyesTransfer(observationId, transferData) {
                this.log('EYES_TRANSFER', {
                    observation_id: observationId,
                    sent_to_backend: transferData,
                    timestamp: Date.now()
                });
            }
            
            logUserAction(action, details) {
                this.log('USER_ACTION', {
                    action: action,
                    details: details,
                    timestamp: Date.now()
                });
            }
            
            logError(error, context) {
                this.log('FRONTEND_ERROR', {
                    error: error.toString(),
                    context: context,
                    stack: error.stack,
                    timestamp: Date.now()
                });
            }
            
            // æ¸¬è©¦è¼”åŠ©æ–¹æ³•
            getLogs() {
                return this.logs;
            }
            
            clearLogs() {
                this.logs = [];
            }
            
            getLogStats() {
                const stats = {};
                this.logs.forEach(log => {
                    stats[log.eventType] = (stats[log.eventType] || 0) + 1;
                });
                return stats;
            }
        }
        
        // åˆå§‹åŒ–æ—¥èªŒè¨˜éŒ„å™¨
        const frontendLogger = new FrontendVisualLogger();
        
        // æ¸¬è©¦å‡½æ•¸
        function testEyesCapture() {
            const observationId = frontendLogger.generateObservationId();
            const requestId = `req_${Date.now()}`;
            
            frontendLogger.logEyesCapture(observationId, requestId, 
                { device: 'Test Camera HD' },
                {
                    resolution: '1920x1080',
                    quality: 0.9,
                    format: 'jpeg',
                    size: '245.6KB'
                }
            );
        }
        
        function testMultipleCaptures() {
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const observationId = frontendLogger.generateObservationId();
                    const requestId = `req_${Date.now()}_${i}`;
                    
                    frontendLogger.logEyesCapture(observationId, requestId,
                        { device: `Camera ${i + 1}` },
                        {
                            resolution: ['1280x720', '1920x1080', '2560x1440'][i],
                            quality: [0.7, 0.8, 0.9][i],
                            format: 'jpeg',
                            size: `${Math.floor(Math.random() * 300 + 100)}KB`
                        }
                    );
                }, i * 500);
            }
        }
        
        function testEyesPrompt() {
            const observationId = frontendLogger.generateObservationId();
            const prompt = document.getElementById('testPrompt').value || 'æè¿°é€™å¼µåœ–ç‰‡ä¸­çš„å…§å®¹';
            
            frontendLogger.logEyesPrompt(observationId, prompt);
        }
        
        function testEyesTransfer() {
            const observationId = frontendLogger.generateObservationId();
            const quality = document.getElementById('testQuality').value;
            const maxTokens = document.getElementById('testTokens').value;
            
            const transferData = {
                max_tokens: parseInt(maxTokens),
                instruction_length: 25,
                has_image: true,
                image_format: 'jpeg',
                request_size_estimate: '156KB'
            };
            
            frontendLogger.logEyesTransfer(observationId, transferData);
        }
        
        function testUserActions() {
            const actions = [
                { action: 'start_processing', details: { instruction: 'æ¸¬è©¦æŒ‡ä»¤', capture_interval: 2000 } },
                { action: 'stop_processing', details: { reason: 'user_initiated' } },
                { action: 'camera_change', details: { device_id: 'camera_1', device_name: 'HD Camera' } }
            ];
            
            actions.forEach((actionData, index) => {
                setTimeout(() => {
                    frontendLogger.logUserAction(actionData.action, actionData.details);
                }, index * 300);
            });
        }
        
        function testSettingChanges() {
            const settings = [
                { setting: 'capture_interval', value: '3000' },
                { setting: 'image_quality', value: '0.8' },
                { setting: 'max_tokens', value: '200' }
            ];
            
            settings.forEach((setting, index) => {
                setTimeout(() => {
                    frontendLogger.logUserAction('setting_change', setting);
                }, index * 200);
            });
        }
        
        function testCompleteFlow() {
            const observationId = frontendLogger.generateObservationId();
            const requestId = `req_${Date.now()}`;
            
            // æ¨¡æ“¬å®Œæ•´æµç¨‹
            setTimeout(() => {
                frontendLogger.logUserAction('start_processing', { instruction: 'å®Œæ•´æµç¨‹æ¸¬è©¦' });
            }, 0);
            
            setTimeout(() => {
                frontendLogger.logEyesCapture(observationId, requestId,
                    { device: 'MacBook Pro Camera' },
                    { resolution: '1280x720', quality: 0.9, format: 'jpeg', size: '189KB' }
                );
            }, 500);
            
            setTimeout(() => {
                frontendLogger.logEyesPrompt(observationId, 'è«‹æè¿°åœ–ç‰‡ä¸­çš„ç‰©é«”å’Œå ´æ™¯');
            }, 1000);
            
            setTimeout(() => {
                frontendLogger.logEyesTransfer(observationId, {
                    max_tokens: 150,
                    instruction_length: 15,
                    has_image: true,
                    image_format: 'jpeg',
                    request_size_estimate: '201KB'
                });
            }, 1500);
            
            setTimeout(() => {
                frontendLogger.log('API_RESPONSE', {
                    observation_id: observationId,
                    status: 200,
                    response_length: 87,
                    has_content: true
                });
            }, 2000);
        }
        
        function testErrorScenarios() {
            const errors = [
                new Error('Camera permission denied'),
                new Error('Network connection failed'),
                new Error('Invalid image format')
            ];
            
            errors.forEach((error, index) => {
                setTimeout(() => {
                    frontendLogger.logError(error, `error_scenario_${index + 1}`);
                }, index * 400);
            });
        }
        
        function validateLogs() {
            const logs = frontendLogger.getLogs();
            const output = document.getElementById('logOutput');
            
            output.innerHTML += `<div class="info">ğŸ“Š æ—¥èªŒé©—è­‰çµæœ:</div>`;
            output.innerHTML += `<div class="success">âœ“ ç¸½æ—¥èªŒæ•¸é‡: ${logs.length}</div>`;
            
            // æª¢æŸ¥å¿…è¦çš„å­—æ®µ
            const requiredFields = ['timestamp', 'sessionId', 'eventType', 'data'];
            let validLogs = 0;
            
            logs.forEach(log => {
                const hasAllFields = requiredFields.every(field => log.hasOwnProperty(field));
                if (hasAllFields) validLogs++;
            });
            
            output.innerHTML += `<div class="success">âœ“ æœ‰æ•ˆæ—¥èªŒæ•¸é‡: ${validLogs}</div>`;
            
            // æª¢æŸ¥è§€å¯ŸIDçš„ä¸€è‡´æ€§
            const observationIds = new Set();
            logs.forEach(log => {
                if (log.data && log.data.observation_id) {
                    observationIds.add(log.data.observation_id);
                }
            });
            
            output.innerHTML += `<div class="success">âœ“ å”¯ä¸€è§€å¯ŸIDæ•¸é‡: ${observationIds.size}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        function showLogStats() {
            const stats = frontendLogger.getLogStats();
            const output = document.getElementById('logOutput');
            
            output.innerHTML += `<div class="info">ğŸ“ˆ æ—¥èªŒçµ±è¨ˆ:</div>`;
            Object.entries(stats).forEach(([eventType, count]) => {
                output.innerHTML += `<div class="success">  ${eventType}: ${count} æ¢è¨˜éŒ„</div>`;
            });
            output.scrollTop = output.scrollHeight;
        }
        
        function clearLogs() {
            frontendLogger.clearLogs();
            document.getElementById('logOutput').innerHTML = '<div class="info">ğŸ“‹ æ—¥èªŒå·²æ¸…é™¤ï¼Œè¼¸å‡ºå°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>';
        }
        
        // é é¢è¼‰å…¥æ™‚è¨˜éŒ„
        window.addEventListener('load', () => {
            frontendLogger.log('PAGE_LOAD', {
                url: window.location.href,
                userAgent: navigator.userAgent.substring(0, 50) + '...',
                timestamp: Date.now()
            });
        });
        
        // è¨˜éŒ„æœªæ•ç²çš„éŒ¯èª¤
        window.addEventListener('error', (event) => {
            frontendLogger.logError(event.error, 'uncaught_error');
        });
    </script>
</body>
</html>