<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Intelligence Hub</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Styles - Create inline fallback for missing CSS files -->
    <style>
        /* Include all the existing CSS from the previous version */
        :root {
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --primary-dark: #1d4ed8;
            --secondary: #06b6d4;
            --secondary-light: #cffafe;
            --accent: #8b5cf6;
            --accent-light: #ede9fe;
            --success: #10b981;
            --success-light: #d1fae5;
            --error: #ef4444;
            --error-light: #fee2e2;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --text: #1e293b;
            --text-light: #64748b;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --bg-secondary: #f1f5f9;
            --border-light: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 2px 4px rgba(0,0,0,0.06);
            --shadow-lg: 0 4px 6px rgba(0,0,0,0.07);
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --header-height: 50px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            --gradient-light: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 100%);
            --padding-sm: 0.5rem;
            --padding-md: 0.75rem;
            --padding-lg: 1rem;
            --content-height: calc(100vh - var(--header-height) - 2rem);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            background-image: 
                radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.03) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.03) 0px, transparent 50%);
            color: var(--text);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-size: 0.82rem;
            letter-spacing: -0.01em;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            height: var(--header-height);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            padding: 0 var(--padding-lg);
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid var(--border-light);
        }
        
        .logo {
            font-weight: 700;
            font-size: 1.1rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo i {
            font-size: 1.2rem;
            color: var(--secondary);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            padding: 0.3rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 1rem;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            position: relative;
        }
        
        .status-dot.online { 
            background-color: var(--success);
            box-shadow: 0 0 0 4px var(--success-light);
        }
        
        .status-dot.offline { 
            background-color: var(--error);
            box-shadow: 0 0 0 4px var(--error-light);
        }
        
        .status-dot.online::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background-color: var(--success);
            opacity: 0.4;
            animation: pulse 2s infinite;
        }
        
        /* Container */
        .container {
            height: var(--content-height);
            margin: 1rem auto;
            padding: 0 var(--padding-lg);
            display: grid;
            grid-template-columns: 3fr 1fr;
            grid-template-rows: 1fr;
            gap: 16px;
            overflow: hidden;
        }
        
        .main-content-flex {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        /* Cards */
        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: var(--padding-md);
            margin-bottom: 0.75rem;
            transition: var(--transition);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.8;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }
        
        .card-title i {
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        /* Video Controls Card */
        .video-controls-card {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        
        .video-controls-layout {
            display: flex;
            gap: 0.75rem;
            height: 100%;
            overflow: hidden;
        }
        
        .video-section {
            flex: 13;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .controls-section {
            flex: 7;
            display: flex;
            flex-direction: column;
        }
        
        /* Video */
        .video-container {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            background-color: rgba(0,0,0,0.9);
            box-shadow: var(--shadow-sm);
            margin-bottom: 0.5rem;
            flex-grow: 1;
        }
        
        .video-preview {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-md);
            background: linear-gradient(to bottom right, #101010, #232323);
            object-fit: cover;
            transition: var(--transition);
        }
        
        .video-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--radius-md);
            border: 2px solid rgba(255,255,255,0.1);
            pointer-events: none;
        }
        
        .thumbnail-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .image-preview {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            border: 2px solid var(--primary);
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.15);
            transition: var(--transition);
        }
        
        .image-preview:hover {
            transform: scale(1.05);
        }
        
        .capture-label {
            font-size: 0.7rem;
            color: var(--text-light);
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 2rem;
            min-width: 150px;
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 0.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 600;
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        
        .settings-label {
            margin-bottom: 0.5rem;
            font-size: 0.7rem;
            color: var(--text-light);
        }
        
        textarea, input, select {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            padding: 0.35rem 0.5rem;
            width: 100%;
            background-color: #fff;
            color: var(--text);
            transition: var(--transition);
        }
        
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        textarea[readonly] {
            background-color: var(--bg-secondary);
            cursor: default;
        }
        
        #instructionText {
            height: 60px;
            resize: none;
        }
        
        /* Parameter grid */
        .parameter-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.4rem;
        }
        
        /* Buttons */
        .btn {
            padding: 0.35rem 0.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37,99,235,0.25);
        }
        
        .btn-danger {
            background-color: var(--error);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: rgba(220,38,38,0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239,68,68,0.25);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Messages */
        .help-msg {
            color: var(--primary);
            font-size: 0.7rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: var(--primary-light);
            border-radius: var(--radius-md);
        }
        
        .help-msg::before {
            content: '\f05a';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 0.5rem;
        }
        
        .error-msg {
            color: var(--error);
            font-size: 0.7rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: var(--error-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-msg::before {
            content: '\f071';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        
        /* Response Card */
        .response-card {
            height: 300px;
            overflow: hidden;
            margin-bottom: 0;
        }
        
        .response-textarea {
            height: 255px;
            resize: none;
            font-size: 0.8rem;
            overflow-y: auto;
        }
        
        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-width: 220px;
            max-width: 280px;
        }
        
        .system-status {
            padding: 0.5rem;
            font-size: 0.75rem;
            margin: 0;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        
        /* Info tabs */
        .info-tabs-card {
            flex-grow: 1;
            margin-bottom: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .tabs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .tabs-header {
            display: flex;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 0.25rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            opacity: 0.6;
        }
        
        .tab-btn.active-tab {
            opacity: 1;
            border-bottom: 2px solid var(--primary);
        }
        
        .tab-btn:hover {
            opacity: 0.85;
        }
        
        .tab-content {
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .tab-panel {
            padding: 0.5rem;
            font-size: 0.75rem;
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .model-info h4 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        
        .model-info p {
            margin-bottom: 0.75rem;
            line-height: 1.5;
            color: var(--text-light);
        }
        
        .feature-list {
            margin-top: 0.75rem;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        
        .feature-item i {
            color: var(--primary);
            width: 16px;
        }
        
        .advice-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .advice-list li {
            padding: 0.25rem 0 0.25rem 1.25rem;
            margin-bottom: 0.5rem;
            position: relative;
            line-height: 1.4;
        }
        
        .advice-list li::before {
            content: "\f00c";
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--secondary);
            position: absolute;
            left: 0;
            top: 0.25rem;
            font-size: 0.7rem;
        }
        
        /* Animations */
        @keyframes pulse {
            0% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 0; transform: scale(1.8); }
            100% { opacity: 0.6; transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .shimmer {
            background: linear-gradient(to right, var(--bg-secondary) 8%, var(--bg-main) 18%, var(--bg-secondary) 33%);
            background-size: 800px 104px;
            animation: shimmer 1.5s infinite linear;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .sidebar {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 24px;
                max-width: none;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 1rem;
            }
            
            .header-status {
                margin-top: 1rem;
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }
            
            .container {
                padding: 0 1rem;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
            
            .video-controls-layout {
                flex-direction: column;
            }
            
            .parameter-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header with logo and status -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-brain"></i>
            <span>Vision Intelligence Hub</span>
        </div>
        <div class="header-status">
            <div class="status-item">
                <span class="status-dot" id="apiStatusDot"></span>
                <span id="apiStatusText">Checking API status...</span>
            </div>
            <div class="status-item">
                <i class="fas fa-microchip"></i>
                <span id="activeModel">Loading model...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="main-content-flex">
                <!-- Video and Controls Card -->
                <div class="card video-controls-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-video"></i>
                            Live Camera Feed & Controls
                        </h2>
                    </div>
                    
                    <!-- Content area with video and controls side by side -->
                    <div class="video-controls-layout">
                        <!-- Video container -->
                        <div class="video-section">
                            <div class="video-container">
                                <video id="videoFeed" class="video-preview" autoplay playsinline></video>
                                <canvas id="canvas" style="display:none;"></canvas>
                            </div>
                            <div class="thumbnail-container">
                                <img id="imagePreview" class="image-preview" style="display:none;" />
                                <span class="capture-label">Click Start to begin</span>
                            </div>
                        </div>
                        
                        <!-- Controls container -->
                        <div class="controls-section">
                            <div class="form-group">
                                <label for="instructionText">Ask about the image:</label>
                                <textarea id="instructionText" rows="2" placeholder="Enter question about the image..."></textarea>
                            </div>
                            
                            <div class="settings-label">
                                <strong>Processing Settings:</strong>
                            </div>
                            
                            <div class="parameter-grid mobile-single-column">
                                <div class="form-group">
                                    <label for="cameraSelect">Select Camera</label>
                                    <select id="cameraSelect"></select>
                                </div>
                                <div>
                                    <label for="intervalSelect">Capture Rate</label>
                                    <select id="intervalSelect">
                                        <option value="2000">2s</option>
                                        <option value="3000">3s</option>
                                        <option value="5000">5s</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="qualitySelect">Image Quality</label>
                                    <select id="qualitySelect">
                                        <option value="0.7">Fast</option>
                                        <option value="0.8">Medium</option>
                                        <option value="0.9" selected>High</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tokensSelect">Max Tokens</label>
                                    <select id="tokensSelect">
                                        <option value="100" selected>100</option>
                                        <option value="200">200</option>
                                        <option value="300">300</option>
                                    </select>
                                </div>
                                <div>
                                    <button id="startButton" class="btn btn-primary">
                                        <i class="fas fa-play"></i>
                                        <span>Start</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="modelHelp" class="help-msg" style="display:none;"></div>
                            <div id="errorMsg" class="error-msg" style="display:none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Response Card -->
                <div class="card response-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-comment-dots"></i>
                            Model Response
                        </h2>
                    </div>
                    <textarea id="responseText" class="response-textarea" readonly placeholder="AI responses will appear here..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Sidebar with info cards -->
        <div class="sidebar">
            <!-- System Status Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-server"></i>
                        System Status
                    </h2>
                </div>
                <div class="system-status" id="systemStatus">Backend not connected. Camera works independently.</div>
            </div>
            
            <!-- Info accordion panel -->
            <div class="card info-tabs-card">
                <!-- Tabs for model info and tips -->
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active-tab" data-target="model-panel">
                            <i class="fas fa-info-circle"></i>
                            Info
                        </button>
                        <button class="tab-btn" data-target="tips-panel">
                            <i class="fas fa-lightbulb"></i>
                            Tips
                        </button>
                    </div>
                
                    <!-- Content panels -->
                    <div class="tab-content">
                        <!-- Model info content -->
                        <div id="model-panel" class="tab-panel active">
                            <div id="modelDesc">
                                <div class="model-info">
                                    <h4>Vision Intelligence Hub</h4>
                                    <p>This application provides real-time vision analysis using AI models. Connect to the backend server for full functionality, or use camera features independently.</p>
                                    <div class="feature-list">
                                        <div class="feature-item">
                                            <i class="fas fa-camera"></i>
                                            <span>Live camera feed</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-brain"></i>
                                            <span>AI vision analysis</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-mobile-alt"></i>
                                            <span>Multi-device support</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tips content -->
                        <div id="tips-panel" class="tab-panel">
                            <ul class="advice-list">
                                <li>Ensure camera permissions are enabled for your browser.</li>
                                <li>Check instruction format if errors occur with AI processing.</li>
                                <li>Adjust capture rate based on your connection speed.</li>
                                <li>Higher image quality provides better AI analysis results.</li>
                                <li>Use descriptive questions for better AI responses.</li>
                                <li>Test different cameras if multiple devices are connected.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules - Fix the import structure -->
    <script type="module">
        // Frontend Visual Logging System
        class FrontendVisualLogger {
            constructor() {
                this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.logToConsole = true;
                this.logToServer = false; // å¯ä»¥å¾ŒçºŒå•Ÿç”¨ç™¼é€åˆ°å¾Œç«¯
                this.observationId = null;
            }
            
            generateObservationId() {
                const timestamp = Date.now();
                this.observationId = `obs_${timestamp}_${Math.random().toString(36).substr(2, 8)}`;
                return this.observationId;
            }
            
            log(eventType, data) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId,
                    eventType: eventType,
                    data: data
                };
                
                if (this.logToConsole) {
                    console.log(`[FrontendVisualLog] ${eventType}:`, data);
                }
                
                // æœªä¾†å¯ä»¥ç™¼é€åˆ°å¾Œç«¯
                // if (this.logToServer) {
                //     this.sendToServer(logEntry);
                // }
            }
            
            logEyesCapture(observationId, requestId, deviceInfo, imageData) {
                this.log('EYES_CAPTURE', {
                    observation_id: observationId,
                    request_id: requestId,
                    device: deviceInfo.device,
                    resolution: imageData.resolution,
                    quality: imageData.quality,
                    format: imageData.format,
                    size: imageData.size,
                    timestamp: Date.now()
                });
            }
            
            logEyesPrompt(observationId, prompt) {
                this.log('EYES_PROMPT', {
                    observation_id: observationId,
                    prompt: prompt,
                    length: prompt.length,
                    timestamp: Date.now()
                });
            }
            
            logEyesTransfer(observationId, transferData) {
                this.log('EYES_TRANSFER', {
                    observation_id: observationId,
                    sent_to_backend: transferData,
                    timestamp: Date.now()
                });
            }
            
            logPageLoad() {
                this.log('PAGE_LOAD', {
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    timestamp: Date.now()
                });
            }
            
            logUserAction(action, details) {
                this.log('USER_ACTION', {
                    action: action,
                    details: details,
                    timestamp: Date.now()
                });
            }
            
            logError(error, context) {
                this.log('FRONTEND_ERROR', {
                    error: error.toString(),
                    context: context,
                    stack: error.stack,
                    timestamp: Date.now()
                });
            }
        }
        
        // åˆå§‹åŒ–å‰ç«¯è¦–è¦ºæ—¥èªŒè¨˜éŒ„å™¨
        const frontendLogger = new FrontendVisualLogger();
        
        // è¨˜éŒ„é é¢è¼‰å…¥
        window.addEventListener('load', () => {
            frontendLogger.logPageLoad();
        });
        
        // è¨˜éŒ„æœªæ•ç²çš„éŒ¯èª¤
        window.addEventListener('error', (event) => {
            frontendLogger.logError(event.error, 'uncaught_error');
        });

        // Create a simplified modular structure that works
        class ConfigManager {
            constructor() {
                this.baseURL = "http://localhost:8000";
                this.config = null;
            }

            async loadConfig() {
                try {
                    const res = await fetch(this.baseURL + "/config", {
                        signal: AbortSignal.timeout(3000)
                    });
                    
                    if (!res.ok) throw new Error("Failed to load configuration");
                    
                    this.config = await res.json();
                    return this.config;
                } catch (error) {
                    console.error("Failed to load config:", error);
                    return null;
                }
            }

            getConfig() {
                return this.config;
            }
        }

        class APIClient {
            constructor() {
                this.baseURL = "http://localhost:8000";
            }

            async checkStatus() {
                try {
                    const res = await fetch(this.baseURL + "/status", {
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    if (res.ok) {
                        return await res.json();
                    } else {
                        throw new Error(`HTTP ${res.status}`);
                    }
                } catch (error) {
                    throw error;
                }
            }

            async sendChatCompletion(instruction, imageBase64URL, maxTokens = 100) {
                // ç²å–è§€å¯ŸIDï¼ˆå¾žåœ–åƒæ•¸æ“šä¸­æå–æˆ–ç”Ÿæˆæ–°çš„ï¼‰
                const observationId = imageBase64URL.observationId || frontendLogger.generateObservationId();
                
                // è¨˜éŒ„è¦–è¦ºæç¤ºè©ž
                frontendLogger.logEyesPrompt(observationId, instruction);
                
                const requestBody = {
                    max_tokens: maxTokens,
                    messages: [
                        { 
                            role: 'user', 
                            content: [
                                { type: 'text', text: instruction },
                                { type: 'image_url', image_url: { url: imageBase64URL } }
                            ]
                        }
                    ]
                };
                
                // è¨˜éŒ„å¾Œç«¯å‚³è¼¸ï¼ˆä¸åŒ…å«å¯¦éš›åœ–åƒæ•¸æ“šä»¥é¿å…æ—¥èªŒéŽå¤§ï¼‰
                frontendLogger.logEyesTransfer(observationId, {
                    max_tokens: maxTokens,
                    instruction_length: instruction.length,
                    has_image: true,
                    image_format: imageBase64URL.split(';')[0].replace('data:image/', ''),
                    request_size_estimate: `${Math.round(JSON.stringify(requestBody).length / 1024)}KB`
                });
                
                const response = await fetch(`${this.baseURL}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: AbortSignal.timeout(30000)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    // è¨˜éŒ„APIéŒ¯èª¤
                    frontendLogger.logError(new Error(`Server error: ${response.status} - ${errorText}`), 'api_request');
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                
                // è¨˜éŒ„APIå›žæ‡‰ï¼ˆä¸åŒ…å«å®Œæ•´å…§å®¹ä»¥é¿å…æ—¥èªŒéŽå¤§ï¼‰
                frontendLogger.log('API_RESPONSE', {
                    observation_id: observationId,
                    status: response.status,
                    response_length: data.choices[0].message.content.length,
                    has_content: !!data.choices[0].message.content,
                    timestamp: Date.now()
                });
                
                return data.choices[0].message.content;
            }
        }

        class CameraManager {
            constructor() {
                this.stream = null;
                this.video = document.getElementById('videoFeed');
                this.canvas = document.getElementById('canvas');
                this.cameraSelect = document.getElementById('cameraSelect');
            }

            async populateCameraList() {
                try {
                    await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');

                    if (videoDevices.length === 0) {
                        throw new Error("No cameras found");
                    }

                    this.cameraSelect.innerHTML = videoDevices.map(device => {
                        const isIPhone = device.label.toLowerCase().includes('continuity') || 
                                       device.label.toLowerCase().includes('iphone');
                        const isMacBook = device.label.toLowerCase().includes('facetime') ||
                                        device.label.toLowerCase().includes('built-in');
                        const isExternal = device.label.toLowerCase().includes('usb') ||
                                         device.label.toLowerCase().includes('capture');
                        
                        let icon = 'ðŸ“· ';
                        if (isIPhone) icon = 'ðŸ“± ';
                        else if (isMacBook) icon = 'ðŸ’» ';
                        else if (isExternal) icon = 'ðŸŽ¥ ';
                        
                        const label = device.label || `Camera ${videoDevices.indexOf(device) + 1}`;
                        return `<option value="${device.deviceId}">${icon}${label}</option>`;
                    }).join('');

                    const macBookCamera = videoDevices.find(d => 
                        d.label.toLowerCase().includes('facetime') || 
                        d.label.toLowerCase().includes('built-in')
                    );

                    const selectedCamera = macBookCamera || videoDevices[0];
                    this.cameraSelect.value = selectedCamera.deviceId;
                    await this.startCamera(selectedCamera.deviceId);

                } catch (err) {
                    console.error("Error accessing cameras:", err);
                    throw err;
                }
            }

            async startCamera(deviceId) {
                try {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                    }

                    const constraints = {
                        video: {
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            facingMode: deviceId ? undefined : "user"
                        },
                        audio: false
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;

                    this.video.onloadedmetadata = () => {
                        this.video.classList.add('animate-fade-in');
                        console.log(`Camera started: ${this.video.videoWidth}x${this.video.videoHeight}`);
                    };

                } catch (err) {
                    throw err;
                }
            }

            captureImage(quality = 0.9) {
                if (!this.stream || !this.video.videoWidth) return null;
                
                try {
                    // ç”Ÿæˆè§€å¯ŸIDå’Œè«‹æ±‚ID
                    const observationId = frontendLogger.generateObservationId();
                    const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
                    
                    const targetWidth = 1024;
                    const aspectRatio = this.video.videoHeight / this.video.videoWidth;
                    const targetHeight = Math.round(targetWidth * aspectRatio);
                    
                    this.canvas.width = targetWidth;
                    this.canvas.height = targetHeight;
                    
                    const ctx = this.canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(this.video, 0, 0, targetWidth, targetHeight);
                    
                    const imageQuality = Math.max(0.92, parseFloat(quality) || 0.9);
                    const imageDataURL = this.canvas.toDataURL('image/jpeg', imageQuality);
                    
                    // ç²å–è¨­å‚™è³‡è¨Š
                    const selectedOption = this.cameraSelect.options[this.cameraSelect.selectedIndex];
                    const deviceInfo = {
                        device: selectedOption ? selectedOption.text : 'Unknown Camera'
                    };
                    
                    // è¨ˆç®—åœ–åƒå¤§å°
                    const imageSizeBytes = Math.round((imageDataURL.length - 'data:image/jpeg;base64,'.length) * 3/4);
                    
                    // è¨˜éŒ„åœ–åƒæ•ç²äº‹ä»¶
                    frontendLogger.logEyesCapture(observationId, requestId, deviceInfo, {
                        resolution: `${targetWidth}x${targetHeight}`,
                        quality: imageQuality,
                        format: 'jpeg',
                        size: `${(imageSizeBytes / 1024).toFixed(1)}KB`
                    });
                    
                    // å°‡è§€å¯ŸIDé™„åŠ åˆ°åœ–åƒæ•¸æ“šä¸­ï¼Œä¾›å¾ŒçºŒä½¿ç”¨
                    imageDataURL.observationId = observationId;
                    imageDataURL.requestId = requestId;
                    
                    return imageDataURL;
                } catch (err) {
                    console.error("Error capturing image:", err);
                    frontendLogger.logError(err, 'image_capture');
                    return null;
                }
            }

            cleanup() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
            }
        }

        class UIManager {
            constructor() {
                this.elements = {
                    apiStatusDot: document.getElementById('apiStatusDot'),
                    apiStatusText: document.getElementById('apiStatusText'),
                    activeModel: document.getElementById('activeModel'),
                    systemStatus: document.getElementById('systemStatus'),
                    modelDesc: document.getElementById('modelDesc'),
                    errorMsg: document.getElementById('errorMsg'),
                    modelHelp: document.getElementById('modelHelp'),
                    instructionText: document.getElementById('instructionText'),
                    responseText: document.getElementById('responseText'),
                    startButton: document.getElementById('startButton'),
                    imagePreview: document.getElementById('imagePreview'),
                    captureLabel: document.querySelector('.capture-label'),
                    intervalSelect: document.getElementById('intervalSelect'),
                    qualitySelect: document.getElementById('qualitySelect'),
                    tokensSelect: document.getElementById('tokensSelect'),
                    cameraSelect: document.getElementById('cameraSelect')
                };
            }

            updateApiStatusOnline(data) {
                this.elements.apiStatusDot.className = "status-dot online";
                this.elements.apiStatusText.textContent = "API Online";
                
                const modelName = data.model_status?.name || data.active_model || "Unknown";
                this.elements.activeModel.textContent = modelName;
                
                const availableModels = data.available_models && data.available_models.length 
                    ? data.available_models.join(", ") 
                    : "None";
                    
                this.elements.systemStatus.innerHTML = `
                    <div style="margin-bottom: 0.75rem;"><strong>Status:</strong> <span style="color: var(--success);">Connected</span></div>
                    <div style="margin-bottom: 0.75rem;"><strong>Active Model:</strong> ${modelName}</div>
                    <div style="margin-bottom: 0.75rem;"><strong>Version:</strong> ${data.model_status?.version || "N/A"}</div>
                    <div><strong>Available Models:</strong> ${availableModels}</div>
                `;

                if (data.model_status?.description) {
                    const modelInfoDiv = document.querySelector('.model-info');
                    if (modelInfoDiv) {
                        const featureList = modelInfoDiv.querySelector('.feature-list');
                        modelInfoDiv.innerHTML = `
                            <h4>${modelName}</h4>
                            <p>${data.model_status.description}</p>
                            ${featureList ? featureList.outerHTML : ''}
                        `;
                    }
                }
            }
            
            updateApiStatusOffline() {
                this.elements.apiStatusDot.className = "status-dot offline";
                this.elements.apiStatusText.textContent = "Backend Offline";
                this.elements.activeModel.textContent = "Camera Only Mode";
                
                this.elements.systemStatus.innerHTML = `
                    <div style="color: var(--warning);"><i class="fas fa-info-circle"></i> Backend Not Connected</div>
                    <div style="margin-top: 0.75rem;">Please start the backend server on port 8000</div>
                    <div style="margin-top: 0.5rem;">Camera functionality works without backend.</div>
                `;
            }

            showError(message) {
                this.elements.errorMsg.textContent = message;
                this.elements.errorMsg.style.display = "block";
            }
            
            hideError() {
                this.elements.errorMsg.style.display = "none";
            }

            updateImagePreview(dataUrl) {
                if (!dataUrl) return;
                
                this.elements.imagePreview.src = dataUrl;
                this.elements.imagePreview.style.display = "inline-block";
                
                if (this.elements.captureLabel) {
                    this.elements.captureLabel.innerHTML = `Frame sent to AI<br><span style="font-size: 0.65rem;">${new Date().toLocaleTimeString()}</span>`;
                    this.elements.captureLabel.style.backgroundColor = "var(--success-light)";
                    this.elements.captureLabel.style.color = "var(--success)";
                    
                    setTimeout(() => {
                        this.elements.captureLabel.style.backgroundColor = "";
                        this.elements.captureLabel.style.color = "";
                    }, 2000);
                }
                
                this.elements.imagePreview.classList.remove('animate-fade-in');
                void this.elements.imagePreview.offsetWidth;
                this.elements.imagePreview.classList.add('animate-fade-in');
            }

            updateProcessingState(isProcessing) {
                if (isProcessing) {
                    this.elements.startButton.innerHTML = '<i class="fas fa-stop"></i><span>Stop</span>';
                    this.elements.startButton.classList.add('btn-danger');
                    this.elements.startButton.classList.remove('btn-primary');
                    
                    this.elements.instructionText.disabled = true;
                    this.elements.intervalSelect.disabled = true;
                    this.elements.qualitySelect.disabled = true;
                    this.elements.tokensSelect.disabled = true;
                    this.elements.cameraSelect.disabled = true;
                    
                    this.elements.responseText.value = "";
                } else {
                    this.elements.startButton.innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
                    this.elements.startButton.classList.add('btn-primary');
                    this.elements.startButton.classList.remove('btn-danger');
                    
                    this.elements.instructionText.disabled = false;
                    this.elements.intervalSelect.disabled = false;
                    this.elements.qualitySelect.disabled = false;
                    this.elements.tokensSelect.disabled = false;
                    this.elements.cameraSelect.disabled = false;
                }
            }
        }

        class TabManager {
            constructor() {
                this.setupTabs();
            }

            setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-btn');
                
                tabButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetId = btn.getAttribute('data-target');
                        const targetPanel = document.getElementById(targetId);
                        
                        // Hide all panels
                        document.querySelectorAll('.tab-panel').forEach(panel => {
                            panel.style.display = 'none';
                            panel.classList.remove('active');
                        });
                        
                        // Show target panel
                        if (targetPanel) {
                            targetPanel.style.display = 'block';
                            targetPanel.classList.add('active');
                        }
                        
                        // Update tab button styles
                        tabButtons.forEach(b => {
                            b.classList.remove('active-tab');
                            b.style.opacity = '0.6';
                            b.style.borderBottom = 'none';
                        });
                        
                        // Set active tab style
                        btn.classList.add('active-tab');
                        btn.style.opacity = '1';
                        btn.style.borderBottom = '2px solid var(--primary)';
                    });
                });
            }
        }

        // Main VisionApp class
        class VisionApp {
            constructor() {
                this.managers = {
                    config: new ConfigManager(),
                    api: new APIClient(),
                    camera: new CameraManager(),
                    ui: new UIManager(),
                    tabs: new TabManager()
                };
                
                this.isProcessing = false;
                this.intervalId = null;
            }

            getManager(name) {
                return this.managers[name];
            }

            async initialize() {
                try {
                    console.log('ðŸš€ Initializing Vision Intelligence Hub...');
                    
                    // Initialize camera
                    await this.managers.camera.populateCameraList();
                    
                    // Try to connect to backend
                    await Promise.allSettled([
                        this.checkApiStatus(),
                        this.loadConfig()
                    ]);
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Initialize UI
                    if (this.managers.ui.elements.captureLabel) {
                        this.managers.ui.elements.captureLabel.innerHTML = `<span style="color: var(--text);">Click Start to begin<br>Camera ready for analysis</span>`;
                    }
                    
                    console.log('âœ… Application initialized successfully');
                    
                } catch (error) {
                    console.error('âŒ Failed to initialize application:', error);
                    this.managers.ui.showError('Application initialization had some issues, but camera should still work.');
                }
            }

            async checkApiStatus() {
                try {
                    const data = await this.managers.api.checkStatus();
                    this.managers.ui.updateApiStatusOnline(data);
                } catch (error) {
                    this.managers.ui.updateApiStatusOffline();
                }
            }

            async loadConfig() {
                try {
                    const config = await this.managers.config.loadConfig();
                    
                    if (config?.model_help) {
                        this.managers.ui.elements.modelHelp.style.display = "block";
                        this.managers.ui.elements.modelHelp.textContent = config.model_help;
                    } else {
                        this.managers.ui.elements.modelHelp.style.display = "block";
                        this.managers.ui.elements.modelHelp.textContent = "Camera is ready. Enter a question about what you want to analyze in the image.";
                    }
                    
                    if (config?.default_instruction) {
                        this.managers.ui.elements.instructionText.value = config.default_instruction;
                    }
                    
                    if (config?.capture_intervals && Array.isArray(config.capture_intervals)) {
                        this.managers.ui.elements.intervalSelect.innerHTML = config.capture_intervals.map(interval => 
                            `<option value="${interval}">${interval/1000}s</option>`
                        ).join('');
                    }
                } catch (error) {
                    console.error("Failed to load config:", error);
                    this.managers.ui.elements.modelHelp.style.display = "block";
                    this.managers.ui.elements.modelHelp.textContent = "Camera is ready. Backend connection required for AI analysis.";
                }
            }

            setupEventListeners() {
                this.managers.ui.elements.startButton.addEventListener('click', () => {
                    if (this.isProcessing) {
                        this.handleStop();
                    } else {
                        this.handleStart();
                    }
                });
                
                this.managers.ui.elements.instructionText.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        if (this.isProcessing) {
                            this.handleStop();
                        } else {
                            this.handleStart();
                        }
                    }
                });

                this.managers.ui.elements.cameraSelect.addEventListener('change', async () => {
                    const selectedDeviceId = this.managers.ui.elements.cameraSelect.value;
                    const selectedOption = this.managers.ui.elements.cameraSelect.options[this.managers.ui.elements.cameraSelect.selectedIndex];
                    
                    // è¨˜éŒ„æ”åƒé ­åˆ‡æ›
                    frontendLogger.logUserAction('camera_change', {
                        device_id: selectedDeviceId,
                        device_name: selectedOption ? selectedOption.text : 'Unknown'
                    });
                    
                    await this.managers.camera.startCamera(selectedDeviceId);
                });

                navigator.mediaDevices.addEventListener('devicechange', async () => {
                    console.log('Camera devices changed');
                    
                    // è¨˜éŒ„è¨­å‚™è®Šæ›´
                    frontendLogger.logUserAction('device_change', {
                        event: 'camera_devices_changed'
                    });
                    
                    await this.managers.camera.populateCameraList();
                });

                // è¨˜éŒ„è¨­ç½®è®Šæ›´
                this.managers.ui.elements.intervalSelect.addEventListener('change', () => {
                    frontendLogger.logUserAction('setting_change', {
                        setting: 'capture_interval',
                        value: this.managers.ui.elements.intervalSelect.value
                    });
                });

                this.managers.ui.elements.qualitySelect.addEventListener('change', () => {
                    frontendLogger.logUserAction('setting_change', {
                        setting: 'image_quality',
                        value: this.managers.ui.elements.qualitySelect.value
                    });
                });

                this.managers.ui.elements.tokensSelect.addEventListener('change', () => {
                    frontendLogger.logUserAction('setting_change', {
                        setting: 'max_tokens',
                        value: this.managers.ui.elements.tokensSelect.value
                    });
                });
            }

            handleStart() {
                if (!this.managers.camera.stream) {
                    this.managers.ui.showError("Camera not available. Please check permissions.");
                    return;
                }
                
                // è¨˜éŒ„ç”¨æˆ¶é–‹å§‹æ“ä½œ
                const intervalTime = this.getValidCaptureInterval();
                const instruction = this.managers.ui.elements.instructionText.value.trim();
                frontendLogger.logUserAction('start_processing', {
                    instruction: instruction,
                    capture_interval: intervalTime,
                    quality: this.managers.ui.elements.qualitySelect.value,
                    max_tokens: this.managers.ui.elements.tokensSelect.value
                });
                
                this.isProcessing = true;
                this.managers.ui.updateProcessingState(true);
                
                this.sendData();
                
                if (this.managers.ui.elements.captureLabel) {
                    this.managers.ui.elements.captureLabel.innerHTML = `Processing starts<br>Capture every ${intervalTime/1000}s`;
                }
                
                this.intervalId = setInterval(() => this.sendData(), intervalTime);
            }
            
            handleStop() {
                // è¨˜éŒ„ç”¨æˆ¶åœæ­¢æ“ä½œ
                frontendLogger.logUserAction('stop_processing', {
                    reason: 'user_initiated'
                });
                
                this.isProcessing = false;
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
                
                this.managers.ui.updateProcessingState(false);
                
                if (this.managers.ui.elements.captureLabel) {
                    this.managers.ui.elements.captureLabel.innerHTML = `<span style="color: var(--text);">Click Start to begin<br>Camera ready for analysis</span>`;
                    this.managers.ui.elements.captureLabel.style.backgroundColor = "";
                    this.managers.ui.elements.captureLabel.style.color = "";
                }
            }

            async sendData() {
                if (!this.isProcessing) return;
                
                if (window.currentRequestProcessing) {
                    console.log("â³ Previous request still processing, skipping this one");
                    return;
                }
                
                this.managers.ui.hideError();
                
                const instruction = this.managers.ui.elements.instructionText.value.trim();
                if (!instruction) {
                    this.managers.ui.showError("Please enter an instruction before starting.");
                    this.handleStop();
                    return;
                }
                
                const quality = this.managers.ui.elements.qualitySelect.value;
                const imageBase64URL = this.managers.camera.captureImage(quality);
                if (!imageBase64URL) {
                    this.managers.ui.showError("Unable to capture image. Please check camera status.");
                    return;
                }
                
                // ç²å–è§€å¯ŸIDï¼ˆå¾žåœ–åƒæ•ç²ä¸­ç²å¾—ï¼‰
                const observationId = imageBase64URL.observationId;
                const requestId = imageBase64URL.requestId;
                
                window.currentRequestProcessing = true;
                
                try {
                    this.managers.ui.updateImagePreview(imageBase64URL);
                    
                    const maxTokens = parseInt(this.managers.ui.elements.tokensSelect.value) || 100;
                    
                    const response = await this.managers.api.sendChatCompletion(instruction, imageBase64URL, maxTokens);
                    
                    this.managers.ui.elements.responseText.value = response || "No response received";
                    
                } catch (error) {
                    this.managers.ui.showError(error.message);
                    frontendLogger.logError(error, 'vlm_request');
                } finally {
                    window.currentRequestProcessing = false;
                }
            }

            getValidCaptureInterval() {
                const defaultInterval = 2000;
                const intervalValue = this.managers.ui.elements.intervalSelect.value;
                
                if (!intervalValue || intervalValue === "none") {
                    return defaultInterval;
                }
                
                const intervalTime = parseInt(intervalValue, 10);
                if (isNaN(intervalTime) || intervalTime < 100) {
                    return defaultInterval;
                }
                
                return intervalTime;
            }

            cleanup() {
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                }
                this.managers.camera.cleanup();
            }
        }

        // Initialize the application
        let app;
        
        async function initializeApp() {
            try {
                console.log('ðŸš€ Initializing Vision Intelligence Hub...');
                
                // Create main application instance
                app = new VisionApp();
                
                // Start the application
                await app.initialize();
                
                console.log('âœ… Application initialized successfully');
                
                // Set up global error handling
                window.addEventListener('error', (event) => {
                    console.error('âŒ Global error:', event.error);
                    const uiManager = app.getManager('ui');
                    if (uiManager) {
                        uiManager.showError('An unexpected error occurred. Please refresh the page.');
                    }
                });
                
                // Set up unload cleanup
                window.addEventListener('beforeunload', () => {
                    if (app) {
                        app.cleanup();
                    }
                });
                
                // Retry API connection periodically when offline
                setInterval(() => {
                    const apiStatusDot = document.getElementById('apiStatusDot');
                    if (apiStatusDot && apiStatusDot.classList.contains('offline')) {
                        app.checkApiStatus();
                    }
                }, 30000);
                
            } catch (error) {
                console.error('âŒ Failed to initialize application:', error);
                
                // Fallback error display
                const errorMsg = document.getElementById('errorMsg');
                if (errorMsg) {
                    errorMsg.textContent = 'Failed to initialize application. Please refresh the page.';
                    errorMsg.style.display = 'block';
                }
            }
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Export for debugging
        window.visionApp = () => app;
    </script>
</body>
</html>